{% extends "base.html" %}
{% load static %}

{% block title %}Pharmacy - Panel{% endblock title %}

{% block style %}
<style>
  * {
    margin: 0;
    padding: 0;
    box-sizing: border-box;
  }

  body {
    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    background: linear-gradient(180deg, #0d2818 0%, #1a472a 50%, #0d2818 100%);
    min-height: 100vh;
    padding: 20px;
    color: white;
  }

  /* Header */
  .header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 20px 30px;
    background: linear-gradient(135deg, #1a472a 0%, #0d2818 100%);
    backdrop-filter: blur(10px);
    -webkit-backdrop-filter: blur(10px);
    border-radius: 15px;
    margin-bottom: 30px;
    box-shadow: 0 8px 32px rgba(0, 0, 0, 0.5);
    border: 1px solid rgba(40, 167, 69, 0.3);
  }

  .header h1 {
    font-size: 1.8rem;
    font-weight: 700;
    letter-spacing: 1px;
  }

  .header-actions {
    display: flex;
    gap: 15px;
    align-items: center;
  }

  .nav-controls {
    display: flex;
    gap: 8px;
    margin-right: 10px;
  }

  .nav-btn {
    background: rgba(40, 167, 69, 0.2);
    color: #28a745;
    width: 40px;
    height: 40px;
    border-radius: 8px;
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    transition: all 0.3s ease;
    border: 1px solid rgba(40, 167, 69, 0.4);
    font-size: 1.2rem;
  }

  .nav-btn:hover {
    background: rgba(40, 167, 69, 0.4);
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(40, 167, 69, 0.3);
    color: white;
  }

  .nav-btn:active {
    transform: translateY(0);
  }

  .back-btn {
    background: linear-gradient(135deg, #28a745 0%, #1e7e34 100%);
    color: white;
    padding: 10px 20px;
    border-radius: 10px;
    text-decoration: none;
    font-size: 0.95rem;
    transition: all 0.3s ease;
    border: none;
    font-weight: 600;
  }

  .back-btn:hover {
    background: linear-gradient(135deg, #1e7e34 0%, #155724 100%);
    transform: translateY(-2px);
    box-shadow: 0 4px 15px rgba(40, 167, 69, 0.4);
  }

  /* Hamburger Menu */
  .hamburger {
    width: 30px;
    height: 25px;
    display: flex;
    flex-direction: column;
    justify-content: space-between;
    cursor: pointer;
    transition: transform 0.3s ease;
  }

  .hamburger:hover {
    transform: scale(1.1);
  }

  .hamburger span {
    display: block;
    height: 3px;
    width: 100%;
    background: white;
    border-radius: 3px;
    transition: all 0.3s ease;
  }

    /* ✅ Side Menu fixed correctly */
    .side-menu {
      position: fixed;
      top: 0;
      right: -318px; /* hidden */
      width: 250px;
      height: 100%;
      background: linear-gradient(180deg, #1a472a 0%, #0d2818 100%);
      box-shadow: -4px 0 20px rgba(0,0,0,0.8);
      transition: right 0.4s ease;
      padding: 20px;
      z-index: 1001;
      border-left: 2px solid rgba(40, 167, 69, 0.5);
    }

    .side-menu.active {
      right: 0;
    }

    .side-menu h4 {
      margin-top: 0;
      color: #fff;
      border-bottom: 1px solid rgba(255,255,255,0.3);
      padding-bottom: 10px;
    }

    .side-menu ul {
      list-style: none;
      padding: 0;
      margin: 20px 0;
    }

    .side-menu ul li {
      margin: 15px 0;
    }

    .side-menu ul li a {
      color: white;
      text-decoration: none;
      font-size: 1rem;
      transition: color 0.3s;
    }

    .side-menu ul li a:hover {
      color: #28a745;
    }

    .close-btn {
      position: absolute;
      top: 15px;
      right: 15px;
      font-size: 1.5rem;
      cursor: pointer;
      color: white;
    }

    /* ✅ Overlay */
    .overlay {
      position: fixed;
      top: 0; left: 0;
      width: 100%; height: 100%;
      background: rgba(0,0,0,0.5);
      z-index: 1000;
      display: none;
    }

    .overlay.active {
      display: block;
    }

    /* ✅ Prescription layout */
    .flex {
      display: flex;
      justify-content: space-between;
      gap: 20px;
    }

    .left {
      flex: 1.5;
    }

    .right {
      flex: 1.5;
      display: flex;
      gap: 20px;
    }

    input[type="text"] {
      padding: 6px;
      border-radius: 5px;
      border: 1px solid #aaa;
      margin-bottom: 6px;
    }

    /* ✅ Smaller fields for days & PKR */
    .small-input {
      width: 60px;
    }

    /* .btn {
      padding: 6px 14px;
      border: none;
      border-radius: 5px;
      cursor: pointer;
      background: #a00;
      color: white;
      font-weight: bold;
    } */

    .btn:hover {
      background: #c00;
    }

    table {
      width: 61%;
      border-spacing: 8px;
      color: white;
    }

    /* ✅ Receipt + Patient boxes side by side */
    .box {
      flex: 1;
      background: white;
      color: black;
      border-radius: 10px;
      padding: 10px;
      min-height: 200px;
    }

    .section-title {
      font-weight: bold;
      margin-bottom: 5px;
      display: block;
    }
    /* ✅ Popup overlay */
    .popup-overlay {
      position: fixed;
      top: 0; left: 0;
      width: 100%; height: 100%;
      background: rgba(0,0,0,0.7);
      display: flex;
      justify-content: center;
      align-items: center;
      z-index: 9999;
      display: none;
    }

    .popup-box {
      background: linear-gradient(180deg, #1a472a 0%, #0d2818 100%);  
      padding: 30px 40px;
      border-radius: 12px;
      text-align: center;
      color: white;
      font-size: 1.2rem;
      box-shadow: 0 8px 30px rgba(0,0,0,0.7);
      animation: popupShow 0.4s ease-out;
      border: 2px solid rgba(40, 167, 69, 0.5);
    }

    .popup-box .tick {
      font-size: 2.5rem;
      color: #28a745;
      margin-bottom: 10px;
    }

    @keyframes popupShow {
      from { transform: scale(0.7); opacity: 0; }
      to   { transform: scale(1); opacity: 1; }
    }

  /* Main Container */
  .container {
    max-width: 1400px;
    margin: 0 auto;
    display: grid;
    grid-template-columns: 1.5fr 1fr;
    gap: 30px;
  }

  /* Card Style */
  .card {
    background: linear-gradient(180deg, rgba(26, 71, 42, 0.9) 0%, rgba(13, 40, 24, 0.95) 100%);
    backdrop-filter: blur(10px);
    -webkit-backdrop-filter: blur(10px);
    border-radius: 20px;
    padding: 30px;
    box-shadow: 0 8px 32px rgba(0, 0, 0, 0.5);
    border: 1px solid rgba(40, 167, 69, 0.3);
    transition: transform 0.3s ease, box-shadow 0.3s ease;
  }

  .card:hover {
    transform: translateY(-5px);
    box-shadow: 0 12px 40px rgba(40, 167, 69, 0.2);
    border-color: rgba(40, 167, 69, 0.5);
  }

  .card-title {
    font-size: 1.4rem;
    font-weight: 700;
    margin-bottom: 25px;
    color: white;
    display: flex;
    align-items: center;
    gap: 10px;
    border-bottom: 2px solid rgba(40, 167, 69, 0.4);
    padding-bottom: 15px;
  }

  .card-title i {
    color: #28a745;
  }

  .card-title span {
    font-size: 1.5rem;
  }

  /* Search Section */
  .search-section {
    display: flex;
    gap: 10px;
    margin-bottom: 30px;
  }

  .search-section input {
    flex: 1;
    padding: 12px 15px;
    border-radius: 10px;
    border: 1px solid rgba(40, 167, 69, 0.4);
    background: rgba(0, 0, 0, 0.3);
    color: white;
    font-size: 1rem;
    transition: all 0.3s ease;
  }

  .search-section input:focus {
    outline: none;
    border-color: #28a745;
    background: rgba(0, 0, 0, 0.4);
    box-shadow: 0 0 15px rgba(40, 167, 69, 0.4);
  }

  .search-section input::placeholder {
    color: rgba(255, 255, 255, 0.5);
  }

  .search-section button {
    width: auto;
    padding: 12px 25px;
  }

  /* Prescription Table */
  .prescription-table {
    width: 100%;
    border-collapse: separate;
    border-spacing: 0 6px;
    margin-bottom: 20px;
  }

  .prescription-table thead th {
    background: rgba(40, 167, 69, 0.2);
    padding: 8px 6px;
    text-align: center;
    font-weight: 600;
    border-radius: 6px;
    color: #28a745;
    border: 1px solid rgba(40, 167, 69, 0.3);
    font-size: 0.8rem;
    white-space: nowrap;
  }

  .prescription-table tbody tr {
    background: rgba(0, 0, 0, 0.2);
    transition: all 0.3s ease;
  }

  .prescription-table tbody tr:hover {
    background: rgba(40, 167, 69, 0.15);
  }

  .prescription-table td {
    padding: 6px 4px;
    border-radius: 4px;
    vertical-align: middle;
  }

  .prescription-table input {
    width: 100%;
    padding: 6px;
    border: 1px solid rgba(40, 167, 69, 0.3);
    border-radius: 6px;
    background: rgba(0, 0, 0, 0.3);
    color: white;
    font-size: 0.8rem;
    transition: all 0.3s ease;
    box-sizing: border-box;
  }

  .prescription-table input:focus {
    outline: none;
    border-color: #28a745;
    background: rgba(0, 0, 0, 0.4);
    box-shadow: 0 0 8px rgba(40, 167, 69, 0.4);
  }

  .prescription-table input::placeholder {
    color: rgba(255, 255, 255, 0.4);
  }

  .prescription-table input:read-only {
    background: rgba(255, 255, 255, 0.05);
    cursor: not-allowed;
    border-color: rgba(255, 255, 255, 0.1);
  }

  .prescription-table .small-input {
    text-align: center;
    font-weight: 600;
  }

  .prescription-table select {
    width: 100%;
    padding: 5px 2px;
    border: 1px solid rgba(40, 167, 69, 0.3);
    border-radius: 6px;
    background: rgba(0, 0, 0, 0.3);
    color: white;
    font-size: 0.75rem;
    cursor: pointer;
    box-sizing: border-box;
  }

  .prescription-table td:first-child {
    border-radius: 6px 0 0 6px;
  }

  .prescription-table td:last-child {
    border-radius: 0 6px 6px 0;
  }

  /* Search Status Message */
  #searchStatus {
    padding: 12px 15px;
    border-radius: 8px;
    font-weight: 500;
    text-align: center;
    animation: slideDown 0.3s ease;
  }

  @keyframes slideDown {
    from {
      opacity: 0;
      transform: translateY(-10px);
    }
    to {
      opacity: 1;
      transform: translateY(0);
    }
  }

  /* Button Styling */
  .btn {
    background: rgba(40, 167, 69, 0.2);
    color: white;
    padding: 12px 30px;
    border-radius: 10px;
    border: 1px solid rgba(40, 167, 69, 0.4);
    font-size: 1rem;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.3s ease;
    width: 100%;
  }

  .btn:hover {
    background: rgba(40, 167, 69, 0.4);
    transform: translateY(-2px);
    box-shadow: 0 5px 20px rgba(40, 167, 69, 0.3);
  }

  .btn-primary {
    background: linear-gradient(135deg, #28a745 0%, #1e7e34 100%);
    border: none;
    box-shadow: 0 4px 15px rgba(40, 167, 69, 0.3);
  }

  .btn-primary:hover {
    background: linear-gradient(135deg, #1e7e34 0%, #155724 100%);
    box-shadow: 0 6px 20px rgba(40, 167, 69, 0.4);
  }

  /* Info Boxes */
  .info-boxes {
    display: grid;
    gap: 20px;
  }

  .info-box {
    background: linear-gradient(145deg, rgba(26, 71, 42, 0.95) 0%, rgba(13, 40, 24, 0.98) 100%);
    border-radius: 16px;
    padding: 0;
    min-height: 200px;
    border: 1px solid rgba(40, 167, 69, 0.4);
    overflow: hidden;
    box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
  }

  .info-box-title {
    font-size: 1rem;
    font-weight: 700;
    color: white;
    display: flex;
    align-items: center;
    gap: 10px;
    background: linear-gradient(135deg, rgba(40, 167, 69, 0.3) 0%, rgba(30, 126, 52, 0.2) 100%);
    padding: 14px 18px;
    border-bottom: 1px solid rgba(40, 167, 69, 0.3);
  }

  .info-box-title i {
    color: #28a745;
    font-size: 1.1rem;
  }

  .info-box-content {
    padding: 18px;
    font-size: 0.9rem;
    line-height: 1.6;
    color: rgba(255, 255, 255, 0.95);
  }

  /* Bill Summary Styles */
  .bill-items {
    max-height: 180px;
    overflow-y: auto;
    margin-bottom: 15px;
    padding-right: 5px;
  }

  .bill-items::-webkit-scrollbar {
    width: 4px;
  }

  .bill-items::-webkit-scrollbar-thumb {
    background: rgba(40, 167, 69, 0.5);
    border-radius: 4px;
  }

  .bill-item {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 10px 12px;
    background: rgba(0, 0, 0, 0.2);
    border-radius: 8px;
    margin-bottom: 8px;
    border-left: 3px solid #28a745;
  }

  .bill-item-name {
    font-weight: 500;
    color: white;
    flex: 1;
  }

  .bill-item-qty {
    color: rgba(255, 255, 255, 0.7);
    font-size: 0.8rem;
    margin: 0 12px;
  }

  .bill-item-price {
    font-weight: 600;
    color: #28a745;
  }

  .bill-divider {
    height: 1px;
    background: linear-gradient(90deg, transparent, rgba(40, 167, 69, 0.5), transparent);
    margin: 15px 0;
  }

  .bill-summary-row {
    display: flex;
    justify-content: space-between;
    padding: 8px 0;
    font-size: 0.9rem;
  }

  .bill-summary-row.total {
    font-size: 1.1rem;
    font-weight: 700;
    color: #28a745;
    padding-top: 12px;
    border-top: 1px dashed rgba(40, 167, 69, 0.4);
    margin-top: 8px;
  }

  .bill-empty {
    text-align: center;
    color: rgba(255, 255, 255, 0.5);
    padding: 30px 15px;
  }

  .bill-empty i {
    font-size: 2.5rem;
    color: rgba(40, 167, 69, 0.3);
    margin-bottom: 12px;
    display: block;
  }

  /* Patient Details Styles */
  .patient-info {
    padding: 5px 0;
  }

  .patient-row {
    display: flex;
    align-items: center;
    padding: 10px 12px;
    background: rgba(0, 0, 0, 0.15);
    border-radius: 8px;
    margin-bottom: 8px;
  }

  .patient-row i {
    color: #28a745;
    width: 24px;
    font-size: 0.9rem;
  }

  .patient-label {
    color: rgba(255, 255, 255, 0.6);
    font-size: 0.8rem;
    width: 80px;
  }

  .patient-value {
    color: white;
    font-weight: 500;
    flex: 1;
  }

  .patient-empty {
    text-align: center;
    color: rgba(255, 255, 255, 0.5);
    padding: 30px 15px;
  }

  .patient-empty i {
    font-size: 2.5rem;
    color: rgba(40, 167, 69, 0.3);
    margin-bottom: 12px;
    display: block;
  }

  /* Responsive Design */
  @media (max-width: 1200px) {
    .container {
      grid-template-columns: 1fr;
    }
  }

  @media (max-width: 768px) {
    .header h1 {
      font-size: 1.3rem;
    }

    .card {
      padding: 20px;
    }

    .card-title {
      font-size: 1.2rem;
    }

    .prescription-table .small-input {
      width: 60px;
    }
  }

  /* Medicine Autocomplete Styles */
  .medicine-search-wrapper {
    position: relative;
    width: 100%;
  }

  .autocomplete-results {
    position: absolute;
    top: 100%;
    left: 0;
    right: 0;
    max-height: 200px;
    overflow-y: auto;
    background: linear-gradient(180deg, #1a472a 0%, #0d2818 100%);
    border: 1px solid rgba(40, 167, 69, 0.5);
    border-radius: 8px;
    box-shadow: 0 8px 20px rgba(0, 0, 0, 0.7);
    z-index: 1000;
    display: none;
  }

  .autocomplete-results.show {
    display: block;
  }

  .autocomplete-item {
    padding: 10px 12px;
    cursor: pointer;
    border-bottom: 1px solid rgba(255, 255, 255, 0.1);
    color: white;
    font-size: 0.9rem;
  }

  .autocomplete-item:hover {
    background: rgba(40, 167, 69, 0.3);
  }

  .autocomplete-item:last-child {
    border-bottom: none;
  }

  .autocomplete-item.empty {
    color: rgba(255, 255, 255, 0.5);
    font-style: italic;
    cursor: default;
  }

  .autocomplete-item.empty:hover {
    background: transparent;
  }

  .autocomplete-item .med-name {
    font-weight: 600;
    color: #28a745;
  }

  .autocomplete-item .med-info {
    font-size: 0.8rem;
    color: rgba(255, 255, 255, 0.7);
    margin-top: 3px;
  }

  /* Timing Select Dropdown */
  .timing-select {
    width: 100%;
    padding: 8px;
    background: rgba(0, 0, 0, 0.4);
    border: 1px solid rgba(40, 167, 69, 0.4);
    border-radius: 6px;
    color: white;
    font-size: 0.85rem;
    cursor: pointer;
  }

  .timing-select:focus {
    outline: none;
    border-color: #28a745;
    box-shadow: 0 0 10px rgba(40, 167, 69, 0.3);
  }

  .timing-select option {
    background: #0d2818;
    color: white;
    padding: 10px;
  }

  /* Thermal Printer Receipt Styles (80mm) */
  .thermal-receipt {
    display: none;
  }

  @media print {
    /* Set page size for thermal printer - 80mm width */
    @page {
      size: 80mm auto;
      margin: 0;
    }
    
    html, body {
      margin: 0 !important;
      padding: 0 !important;
      width: 80mm !important;
      background: #fff !important;
    }
    
    body * {
      display: none !important;
    }
    
    .thermal-receipt {
      display: block !important;
      position: absolute;
      left: 0;
      top: 0;
      width: 76mm;  /* 80mm - 4mm padding */
      max-width: 76mm;
      padding: 2mm;
      margin: 0;
      font-family: 'Courier New', monospace;
      font-size: 12pt;
      line-height: 1.4;
      color: #000 !important;
      background: #fff !important;
      overflow: hidden;
      -webkit-print-color-adjust: exact !important;
      print-color-adjust: exact !important;
    }
    
    .thermal-receipt,
    .thermal-receipt *,
    .thermal-receipt div,
    .thermal-receipt span,
    .thermal-receipt p {
      color: #000 !important;
      font-weight: 900 !important;
      -webkit-print-color-adjust: exact !important;
      print-color-adjust: exact !important;
    }
    
    .thermal-receipt * {
      display: block !important;
      box-shadow: none !important;
      text-shadow: none !important;
      background: transparent !important;
      border-radius: 0 !important;
      color: #000 !important;
      font-weight: 900 !important;
    }
    
    .thermal-receipt .info-line,
    .thermal-receipt .item-details,
    .thermal-receipt .total-line {
      display: flex !important;
    }
    
    .thermal-receipt .header {
      text-align: center;
      border-bottom: 2px solid #000;
      padding-bottom: 2mm;
      margin-bottom: 2mm;
    }
    
    .thermal-receipt .header div {
      color: #000 !important;
      font-weight: 900 !important;
      text-shadow: 0 0 0 #000;
      -webkit-font-smoothing: none;
    }
    
    .thermal-receipt .clinic-name {
      font-size: 12pt !important;
      font-weight: 900 !important;
      margin-bottom: 1mm;
      color: #000 !important;
      letter-spacing: 0.3mm;
      text-shadow: 0 0 0 #000;
    }
    
    .thermal-receipt .receipt-title {
      font-size: 11pt !important;
      font-weight: 900 !important;
      margin-top: 1mm;
      color: #000 !important;
      text-decoration: underline;
      text-shadow: 0 0 0 #000;
    }
    
    .thermal-receipt .dept-name {
      font-size: 10pt !important;
      font-weight: 900 !important;
      color: #000 !important;
      text-shadow: 0 0 0 #000;
    }
    
    .thermal-receipt .info-line {
      justify-content: space-between;
      margin: 0.5mm 0;
      font-size: 10pt;
      font-weight: 900 !important;
      color: #000 !important;
    }
    
    .thermal-receipt .section-title {
      font-weight: 900 !important;
      border-bottom: 2px solid #000;
      padding: 1mm 0;
      margin: 1mm 0;
      font-size: 11pt;
      color: #000 !important;
    }
    
    .thermal-receipt .item-row {
      margin: 0.5mm 0;
      font-size: 9pt;
      word-wrap: break-word;
      overflow-wrap: break-word;
      font-weight: bold !important;
      color: #000 !important;
    }
    
    .thermal-receipt .item-name {
      font-weight: bold !important;
      font-size: 10pt;
      max-width: 70mm;
      overflow: hidden;
      text-overflow: ellipsis;
      color: #000 !important;
    }
    
    .thermal-receipt .item-details {
      justify-content: space-between;
      padding-left: 1mm;
      font-size: 9pt;
      font-weight: bold !important;
      color: #000 !important;
    }
    
    .thermal-receipt .totals {
      border-top: 2px solid #000;
      margin-top: 2mm;
      padding-top: 1mm;
    }
    
    .thermal-receipt .total-line {
      justify-content: space-between;
      margin: 0.5mm 0;
      font-size: 10pt;
      font-weight: bold !important;
      color: #000 !important;
    }
    
    .thermal-receipt .discount-line {
      color: #000 !important;
      font-size: 9pt;
      font-weight: bold !important;
    }
    
    .thermal-receipt .grand-total {
      font-size: 12pt;
      font-weight: 900 !important;
      border-top: 2px solid #000;
      padding-top: 1mm;
      margin-top: 1mm;
      color: #000 !important;
    }
    
    .thermal-receipt .footer {
      text-align: center;
      border-top: 2px solid #000;
      margin-top: 2mm;
      padding-top: 1mm;
      font-size: 9pt;
      font-weight: bold !important;
      color: #000 !important;
    }
    
    .thermal-receipt .thank-you {
      font-weight: 900 !important;
      font-size: 11pt;
      margin: 1mm 0;
      color: #000 !important;
    }
  }
  
  /* ========== PHARMACY QUEUE PANEL STYLES ========== */
  .pharmacy-queue-toggle {
    position: fixed;
    left: 0;
    top: 50%;
    transform: translateY(-50%);
    background: linear-gradient(135deg, #28a745 0%, #1a472a 100%);
    color: white;
    padding: 15px 10px;
    writing-mode: vertical-rl;
    text-orientation: mixed;
    cursor: pointer;
    border-radius: 0 12px 12px 0;
    z-index: 999;
    font-weight: 600;
    letter-spacing: 1px;
    box-shadow: 3px 0 15px rgba(0, 0, 0, 0.3);
    transition: all 0.3s ease;
  }

  .pharmacy-queue-toggle:hover {
    padding-left: 15px;
    box-shadow: 5px 0 25px rgba(0, 0, 0, 0.4);
  }

  .pharmacy-queue-panel {
    position: fixed;
    left: -320px;
    top: 0;
    width: 320px;
    height: 100vh;
    background: linear-gradient(180deg, #1a472a 0%, #0d2818 100%);
    z-index: 1002;
    transition: left 0.4s cubic-bezier(0.4, 0, 0.2, 1);
    box-shadow: 4px 0 25px rgba(0, 0, 0, 0.5);
    display: flex;
    flex-direction: column;
  }

  .pharmacy-queue-panel.active {
    left: 0;
  }

  .pharmacy-queue-header {
    padding: 20px;
    background: rgba(0, 0, 0, 0.3);
    border-bottom: 2px solid rgba(40, 167, 69, 0.5);
    display: flex;
    justify-content: space-between;
    align-items: center;
  }

  .pharmacy-queue-header h2 {
    font-size: 1.3rem;
    font-weight: 700;
    color: white;
    display: flex;
    align-items: center;
    gap: 10px;
  }

  .pharmacy-queue-close {
    background: rgba(255, 255, 255, 0.1);
    border: none;
    color: white;
    width: 35px;
    height: 35px;
    border-radius: 8px;
    cursor: pointer;
    font-size: 1.2rem;
    transition: all 0.3s ease;
  }

  .pharmacy-queue-close:hover {
    background: rgba(220, 53, 69, 0.5);
  }

  .pharmacy-queue-stats {
    display: flex;
    gap: 10px;
    padding: 15px 20px;
    background: rgba(0, 0, 0, 0.2);
    border-bottom: 1px solid rgba(255, 255, 255, 0.1);
  }

  .pharmacy-queue-stat {
    flex: 1;
    text-align: center;
    padding: 12px;
    background: rgba(255, 255, 255, 0.08);
    border-radius: 10px;
  }

  .pharmacy-queue-stat-number {
    font-size: 1.8rem;
    font-weight: 700;
    color: #28a745;
  }

  .pharmacy-queue-stat-label {
    font-size: 0.75rem;
    color: rgba(255, 255, 255, 0.7);
    text-transform: uppercase;
    letter-spacing: 0.5px;
    margin-top: 5px;
  }

  .pharmacy-queue-list {
    flex: 1;
    overflow-y: auto;
    padding: 15px;
  }

  .pharmacy-queue-item {
    background: rgba(255, 255, 255, 0.08);
    border-radius: 12px;
    padding: 15px;
    margin-bottom: 12px;
    cursor: pointer;
    transition: all 0.3s ease;
    border: 2px solid transparent;
  }

  .pharmacy-queue-item:hover {
    background: rgba(255, 255, 255, 0.15);
    transform: translateX(5px);
  }

  .pharmacy-queue-item.dispensing {
    border-color: #ffc107;
    background: rgba(255, 193, 7, 0.15);
  }

  .pharmacy-queue-item.selected {
    border-color: #28a745;
    background: rgba(40, 167, 69, 0.2);
  }

  .pharmacy-queue-number {
    display: inline-flex;
    align-items: center;
    justify-content: center;
    width: 35px;
    height: 35px;
    background: linear-gradient(135deg, #28a745 0%, #1e7e34 100%);
    color: white;
    border-radius: 50%;
    font-weight: 700;
    font-size: 1rem;
    margin-right: 12px;
  }

  .pharmacy-queue-item.dispensing .pharmacy-queue-number {
    background: linear-gradient(135deg, #ffc107 0%, #e0a800 100%);
  }

  .pharmacy-queue-item-content {
    flex: 1;
  }

  .pharmacy-queue-patient-name {
    font-weight: 600;
    font-size: 1rem;
    color: white;
    margin-bottom: 4px;
  }

  .pharmacy-queue-patient-details {
    display: flex;
    align-items: center;
    gap: 10px;
    font-size: 0.85rem;
    color: rgba(255, 255, 255, 0.7);
  }

  .pharmacy-queue-patient-ref {
    color: #28a745;
    font-weight: 500;
  }

  .pharmacy-queue-time {
    font-size: 0.8rem;
    color: rgba(255, 255, 255, 0.5);
    margin-top: 6px;
  }

  .pharmacy-queue-badge {
    display: inline-block;
    padding: 3px 8px;
    border-radius: 12px;
    font-size: 0.7rem;
    font-weight: 600;
    text-transform: uppercase;
    margin-left: auto;
  }

  .pharmacy-queue-badge.dispensing {
    background: #ffc107;
    color: #000;
  }

  .pharmacy-queue-badge.rx-count {
    background: rgba(40, 167, 69, 0.3);
    color: #28a745;
    font-size: 0.75rem;
  }

  .pharmacy-queue-refresh {
    padding: 15px 20px;
    background: rgba(0, 0, 0, 0.3);
    border-top: 1px solid rgba(255, 255, 255, 0.1);
  }

  .pharmacy-queue-refresh button {
    width: 100%;
    padding: 12px;
    background: linear-gradient(135deg, #28a745 0%, #1e7e34 100%);
    border: none;
    color: white;
    border-radius: 8px;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.3s ease;
  }

  .pharmacy-queue-refresh button:hover {
    background: linear-gradient(135deg, #1e7e34 0%, #155724 100%);
  }

  .pharmacy-queue-empty {
    text-align: center;
    padding: 40px 20px;
    color: rgba(255, 255, 255, 0.5);
  }

  .pharmacy-queue-empty i {
    font-size: 3rem;
    margin-bottom: 15px;
    color: rgba(40, 167, 69, 0.3);
  }
  </style>
{% endblock style %}


    
{% block content %}

<!-- Pharmacy Queue Toggle Button -->
<div class="pharmacy-queue-toggle" onclick="togglePharmacyQueue()" title="Prescription Queue">
  <i class="fas fa-pills"></i> QUEUE <span id="pharmacyQueueCount" class="badge bg-success ms-1" style="font-size: 0.9rem; padding: 3px 8px;">0</span>
</div>

<!-- Pharmacy Queue Panel -->
<div class="pharmacy-queue-panel" id="pharmacyQueuePanel">
  <div class="pharmacy-queue-header">
    <h2><i class="fas fa-pills"></i> Prescription Queue</h2>
    <button class="pharmacy-queue-close" onclick="togglePharmacyQueue()">
      <i class="fas fa-times"></i>
    </button>
  </div>
  
  <div class="pharmacy-queue-stats">
    <div class="pharmacy-queue-stat">
      <div class="pharmacy-queue-stat-number" id="waitingCount">0</div>
      <div class="pharmacy-queue-stat-label">Waiting</div>
    </div>
    <div class="pharmacy-queue-stat">
      <div class="pharmacy-queue-stat-number" id="dispensingCount" style="color: #ffc107;">0</div>
      <div class="pharmacy-queue-stat-label">Dispensing</div>
    </div>
  </div>
  
  <div class="pharmacy-queue-list" id="pharmacyQueueList">
    <!-- Queue items will be loaded here -->
    <div class="pharmacy-queue-empty">
      <i class="fas fa-inbox"></i>
      <p>No prescriptions in queue</p>
    </div>
  </div>
  
  <div class="pharmacy-queue-refresh">
    <button onclick="loadPharmacyQueue()">
      <i class="fas fa-sync-alt"></i> Refresh Queue
    </button>
  </div>
</div>

<!-- Header -->
<div class="header">
  <h1><i class="fas fa-pills"></i> Pharmacy Panel</h1>
  <div class="header-actions">
    <div class="nav-controls">
      <div class="nav-btn" onclick="history.back()" title="Back"><i class="fas fa-arrow-left"></i></div>
      <div class="nav-btn" onclick="history.forward()" title="Forward"><i class="fas fa-arrow-right"></i></div>
      <div class="nav-btn" onclick="location.reload()" title="Refresh"><i class="fas fa-sync-alt"></i></div>
    </div>
    <a href="{% url 'admitted_patients_pharmacy' %}" class="back-btn" style="background: #007bff; border-color: #007bff;"><i class="fas fa-hospital"></i> Admitted Patients</a>
    <a href="javascript:history.back()" class="back-btn"><i class="fas fa-arrow-left"></i> Back</a>
    <div class="hamburger" id="hamburger">
      <span></span>
      <span></span>
      <span></span>
    </div>
  </div>
</div>

<!-- Main Container -->
<div class="container">
  <!-- Left Card - Prescription Entry -->
  <div class="card">
    <div class="card-title">
      <span><i class="fas fa-clipboard-list"></i></span>
      PRESCRIPTION PROCESSING
      <div style="margin-left: auto; display: flex; gap: 10px;">
        <button class="btn" onclick="openReturnModal()" id="returnBtn" style="padding: 8px 15px; font-size: 0.85rem; background: linear-gradient(135deg, #28a745 0%, #1e7e34 100%);">
          <i class="fas fa-undo-alt"></i> Return
        </button>
        <button class="btn" onclick="toggleDirectSale()" id="directSaleToggle" style="padding: 8px 15px; font-size: 0.85rem;">
          <i class="fas fa-shopping-cart"></i> Direct Sale
        </button>
      </div>
    </div>

    <!-- Mode Indicator -->
    <div id="modeIndicator" style="margin-bottom: 15px; padding: 10px; border-radius: 8px; background: rgba(76, 175, 80, 0.3); display: none;">
      <strong><i class="fas fa-box"></i> Direct Sale Mode</strong> - Add medicines manually
    </div>

    <!-- Search Prescription -->
    <div class="search-section">
      <input 
        type="text" 
        placeholder="Enter patient reference number or name..."
        id="refNoInput"
      >
      <button class="btn" onclick="searchPrescription()"><i class="fas fa-search"></i> Search</button>
    </div>

    <!-- Search Status Message -->
    <div id="searchStatus" style="margin-bottom: 15px; padding: 10px; border-radius: 8px; display: none;"></div>

    <!-- Prescription Table -->
    <div class="card-title" style="font-size: 1.1rem; margin-bottom: 15px; margin-top: 20px;">
      <span><i class="fas fa-pills"></i></span>
      Medicine Details
    </div>

    <div class="prescription-table-wrapper">
    <table class="prescription-table" style="width: 100%; table-layout: fixed;">
      <thead>
        <tr>
          <th style="width: 25%;">Medicine</th>
          <th style="width: 8%;">QTY</th>
          <th style="width: 10%;">Form</th>
          <th style="width: 8%;">Freq</th>
          <th style="width: 19%;">اردو</th>
          <th style="width: 8%;">Days</th>
          <th style="width: 14%;">Price</th>
          <th style="width: 8%;">Del</th>
        </tr>
      </thead>
      <tbody id="prescriptionRows">
        <!-- Medicines will be loaded here -->
      </tbody>
    </table>
    </div>

    <!-- Add Medicine Button (for Direct Sale) -->
    <div id="addMedicineSection" style="margin-bottom: 20px; display: none;">
      <button class="btn" onclick="addMedicineRow()" style="width: 100%;">
        <i class="fas fa-plus"></i> Add Medicine
      </button>
    </div>

    <div style="background: rgba(0, 0, 0, 0.2); padding: 20px; border-radius: 12px; margin: 20px 0; border: 1px solid rgba(255, 255, 255, 0.1);">
      <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
        <div>
          <label style="display: block; font-weight: 600; margin-bottom: 8px; color: white; font-size: 0.9rem;">Discount Amount (PKR)</label>
          <input type="number" id="discountAmount" placeholder="0.00" min="0" step="0.01" oninput="updateDiscountFromAmount()" 
                 style="width: 100%; padding: 10px; border: 1px solid rgba(255, 255, 255, 0.3); border-radius: 8px; background: rgba(255, 255, 255, 0.15); color: white; font-size: 1rem;">
        </div>
        <div>
          <label style="display: block; font-weight: 600; margin-bottom: 8px; color: white; font-size: 0.9rem;">Discount Percentage (%)</label>
          <input type="number" id="discountPercentage" placeholder="0.00" min="0" max="100" step="0.01" oninput="updateDiscountFromPercentage()"
                 style="width: 100%; padding: 10px; border: 1px solid rgba(255, 255, 255, 0.3); border-radius: 8px; background: rgba(255, 255, 255, 0.15); color: white; font-size: 1rem;">
        </div>
      </div>
    </div>

    <button class="btn btn-primary" id="printSaveBtn" onclick="processOrder()">
      <i class="fas fa-check"></i> PRINT / SAVE
    </button>
    
    <!-- Print Receipt Button (shows after processing) -->
    <button class="btn" id="printReceiptBtn" onclick="printReceipt()" style="display: none; margin-top: 10px; background: linear-gradient(135deg, #ff9800 0%, #e65100 100%);">
      <i class="fas fa-print"></i> PRINT RECEIPT AGAIN
    </button>
  </div>

  <!-- Right Card - Info Boxes -->
  <div class="info-boxes">
    <!-- Receipt/Bill Box -->
    <div class="info-box">
      <div class="info-box-title">
        <i class="fas fa-receipt"></i>
        RECEIPT / BILL
      </div>
      <div class="info-box-content" id="billContent">
        <div class="bill-empty">
          <i class="fas fa-shopping-cart"></i>
          <p>No items added yet</p>
          <small>Add medicines to see bill preview</small>
        </div>
      </div>
    </div>

    <!-- Patient Details Box -->
    <div class="info-box">
      <div class="info-box-title">
        <i class="fas fa-user-circle"></i>
        Patient Details
      </div>
      <div class="info-box-content" id="patientContent">
        <div class="patient-empty">
          <i class="fas fa-user-slash"></i>
          <p>No patient selected</p>
          <small>Search by reference number</small>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Password Lock Screen for Sidebar -->
<div id="menuPasswordOverlay" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 9998; justify-content: center; align-items: center;">
  <div style="background: #1a1a2e; padding: 30px; border-radius: 15px; text-align: center; max-width: 350px; width: 90%; box-shadow: 0 10px 40px rgba(0,0,0,0.5);">
    <i class="fas fa-lock" style="font-size: 50px; color: #28a745; margin-bottom: 20px;"></i>
    <h3 style="color: white; margin-bottom: 20px;">Menu Locked</h3>
    <p style="color: #aaa; font-size: 14px; margin-bottom: 20px;">Enter your staff password to access menu</p>
    <input type="password" id="menuPasswordInput" placeholder="Enter Password" 
           style="width: 100%; padding: 12px; border: 2px solid #333; border-radius: 8px; background: #0f0f1a; color: white; font-size: 16px; text-align: center; margin-bottom: 15px;"
           onkeypress="if(event.key === 'Enter') verifyMenuPassword()">
    <button onclick="verifyMenuPassword()" 
            style="width: 100%; padding: 12px; background: linear-gradient(135deg, #28a745, #20c997); color: white; border: none; border-radius: 8px; font-size: 16px; font-weight: bold; cursor: pointer; margin-bottom: 10px;">
      <i class="fas fa-unlock"></i> Unlock Menu
    </button>
    <button onclick="closePasswordPrompt()" 
            style="width: 100%; padding: 10px; background: transparent; color: #999; border: 1px solid #444; border-radius: 8px; cursor: pointer;">
      Cancel
    </button>
    <div id="passwordError" style="color: #dc3545; margin-top: 15px; display: none;">
      <i class="fas fa-exclamation-circle"></i> <span id="passwordErrorText">Invalid password</span>
    </div>
  </div>
</div>

<!-- Side Menu -->
<div class="side-menu" id="sideMenu">
  <span class="close-btn" id="closeMenu">&times;</span>
  <h4><i class="fas fa-pills"></i> Menu</h4>
  <ul>
    <li><a href="/"><i class="fas fa-home"></i> Home</a></li>
    <li><a href="{% url 'inventory:product_list' %}"><i class="fas fa-boxes"></i> Inventory</a></li>
    <li><a href="/admin/" target="_blank"><i class="fas fa-cog"></i> Admin Panel</a></li>
    <li><a href="#" onclick="openSettings(); return false;"><i class="fas fa-sliders-h"></i> Settings</a></li>
    <li><a href="/"><i class="fas fa-sign-out-alt"></i> Logout</a></li>
  </ul>
  
  <!-- Network Connection Section -->
  <div style="border-top: 1px solid rgba(255,255,255,0.2); margin-top: 15px; padding-top: 15px;">
    <h5 style="color: #28a745; margin-bottom: 10px; font-size: 0.9rem;"><i class="fas fa-network-wired"></i> Network Status</h5>
    <div id="networkStatusBox" style="background: rgba(0,0,0,0.3); padding: 10px; border-radius: 8px; font-size: 0.85rem;">
      <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 8px;">
        <span id="networkStatusIcon" style="color: #ffc107;"><i class="fas fa-circle"></i></span>
        <span id="networkStatusText">Checking...</span>
      </div>
      <div id="networkIPInfo" style="color: #aaa; font-size: 0.8rem;"></div>
    </div>
    
    <!-- Server Mode Button (for Pharmacy) -->
    <button id="btnSetServer" onclick="setAsServer()" style="width: 100%; margin-top: 10px; padding: 10px; background: linear-gradient(135deg, #28a745 0%, #1e7e34 100%); color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: bold; display: none;">
      <i class="fas fa-server"></i> Start as Server
    </button>
    
    <!-- Connect to Server Section -->
    <div id="connectSection" style="margin-top: 10px; display: none;">
      <input type="text" id="serverIPInput" placeholder="Enter Server IP (e.g., 192.168.1.100)" style="width: 100%; padding: 8px; border-radius: 5px; border: 1px solid #444; background: rgba(0,0,0,0.3); color: white; margin-bottom: 8px;">
      <button onclick="connectToServer()" style="width: 100%; padding: 10px; background: #007bff; color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: bold;">
        <i class="fas fa-plug"></i> Connect
      </button>
    </div>
    
    <!-- Disconnect Button -->
    <button id="btnDisconnect" onclick="disconnectFromServer()" style="width: 100%; margin-top: 10px; padding: 10px; background: #dc3545; color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: bold; display: none;">
      <i class="fas fa-unlink"></i> Disconnect
    </button>
  </div>
</div>

<!-- Settings Modal -->
<div class="settings-modal-overlay" id="settingsModal">
  <div class="settings-modal">
    <div class="settings-header">
      <h3><i class="fas fa-cog"></i> Settings</h3>
      <span class="settings-close" onclick="closeSettings()">&times;</span>
    </div>
    
    <div class="settings-content">
      <!-- Database Info Section -->
      <div class="settings-section">
        <h4><i class="fas fa-database"></i> Database Information</h4>
        <div class="db-info" id="dbInfo">
          <div class="db-info-row">
            <span class="db-label">Location:</span>
            <span class="db-value" id="dbPath">Loading...</span>
          </div>
          <div class="db-info-row">
            <span class="db-label">Size:</span>
            <span class="db-value" id="dbSize">Loading...</span>
          </div>
          <div class="db-info-row">
            <span class="db-label">Last Modified:</span>
            <span class="db-value" id="dbModified">Loading...</span>
          </div>
        </div>
      </div>
      
      <!-- Local Backup Section -->
      <div class="settings-section">
        <h4><i class="fas fa-download"></i> Local Backup</h4>
        <p class="settings-desc">Download a complete backup of your database. Keep it safe!</p>
        <button class="settings-btn backup-btn" onclick="downloadBackup()">
          <span><i class="fas fa-download"></i></span> Download Database Backup
        </button>
      </div>
      
      <!-- Cloud Backup Section -->
      <div class="settings-section">
        <h4><i class="fas fa-cloud"></i> Google Drive Cloud Backup</h4>
        <p class="settings-desc">Automatically backup to your Google Drive for extra safety.</p>
        
        <div id="gdriveStatus" style="padding: 10px; border-radius: 8px; margin: 10px 0; background: rgba(0,0,0,0.2);">
          <span id="gdriveStatusText">Checking connection...</span>
        </div>
        
        <div id="gdriveNotConnected" style="display: none;">
          <p style="font-size: 0.85rem; color: #ffc107; margin: 10px 0;">
            <i class="fas fa-exclamation-triangle"></i> First time setup required. You need Google OAuth credentials.
          </p>
          <button class="settings-btn" onclick="showGDriveSetup()" style="background: #4285f4; margin-bottom: 10px;">
            <span><i class="fas fa-key"></i></span> Setup Google Drive
          </button>
        </div>
        
        <div id="gdriveConnected" style="display: none;">
          <button class="settings-btn" onclick="backupToGDrive()" style="background: #0f9d58;">
            <span><i class="fas fa-cloud-upload-alt"></i></span> Backup to Google Drive Now
          </button>
          <button class="settings-btn" onclick="disconnectGDrive()" style="background: #db4437; margin-top: 10px;">
            <span><i class="fas fa-unlink"></i></span> Disconnect Google Drive
          </button>
        </div>
      </div>
      
      <!-- Restore Section -->
      <div class="settings-section">
        <h4><i class="fas fa-upload"></i> Restore Database</h4>
        <p class="settings-desc">Upload a previously saved backup file to restore data.</p>
        <p class="settings-info" style="color: #4CAF50; font-size: 0.85rem; margin: 5px 0;"><i class="fas fa-check"></i> Compatible with all app versions! Database will be automatically updated.</p>
        <p class="settings-warning"><i class="fas fa-exclamation-triangle"></i> Warning: This will replace all current data!</p>
        <input type="file" id="dbFileInput" accept=".sqlite3" style="display: none;" onchange="uploadBackup()">
        <button class="settings-btn restore-btn" onclick="document.getElementById('dbFileInput').click()">
          <span><i class="fas fa-upload"></i></span> Upload & Restore Backup
        </button>
      </div>
      
      <!-- Close App Section -->
      <div class="settings-section" style="border-top: 2px solid rgba(255,255,255,0.2); padding-top: 20px; margin-top: 20px;">
        <h4><i class="fas fa-power-off"></i> Close Application</h4>
        <p class="settings-desc">Close the application. You'll be prompted to backup first.</p>
        <button class="settings-btn" onclick="closeAppWithBackup()" style="background: linear-gradient(135deg, #e74c3c 0%, #c0392b 100%);">
          <span><i class="fas fa-times"></i></span> Close & Backup
        </button>
      </div>
    </div>
  </div>
</div>

<!-- Google Drive Setup Modal -->
<div class="gdrive-setup-modal" id="gdriveSetupModal">
  <div class="gdrive-setup-content">
    <span class="close-gdrive-setup" onclick="closeGDriveSetup()">&times;</span>
    <h3><i class="fas fa-cloud"></i> Google Drive Setup</h3>
    
    <div id="gdriveSetupStep1">
      <p style="margin-bottom: 15px;">To enable Google Drive backup, you need to create OAuth credentials:</p>
      <ol style="text-align: left; padding-left: 20px; font-size: 0.9rem; line-height: 1.8;">
        <li>Go to <a href="https://console.cloud.google.com" target="_blank" style="color: #4285f4;">Google Cloud Console</a></li>
        <li>Create a new project (or select existing)</li>
        <li>Enable "Google Drive API"</li>
        <li>Go to "Credentials" → "Create Credentials" → "OAuth client ID"</li>
        <li>Choose "Desktop application"</li>
        <li>Copy the Client ID and Client Secret below</li>
      </ol>
      
      <div style="margin-top: 15px;">
        <label style="display: block; margin-bottom: 5px; font-weight: 600;">Client ID:</label>
        <input type="text" id="gdriveClientId" placeholder="xxxx.apps.googleusercontent.com" 
               style="width: 100%; padding: 10px; border-radius: 8px; border: 1px solid #ccc; margin-bottom: 10px;">
        
        <label style="display: block; margin-bottom: 5px; font-weight: 600;">Client Secret:</label>
        <input type="text" id="gdriveClientSecret" placeholder="GOCSPX-xxxx" 
               style="width: 100%; padding: 10px; border-radius: 8px; border: 1px solid #ccc;">
      </div>
      
      <button onclick="saveGDriveCredentials()" style="margin-top: 15px; padding: 12px 25px; background: #4285f4; color: white; border: none; border-radius: 8px; cursor: pointer; font-size: 1rem;">
        Save & Continue →
      </button>
    </div>
    
    <div id="gdriveSetupStep2" style="display: none;">
      <p style="margin-bottom: 15px;">Click the button below to authorize access to your Google Drive:</p>
      
      <button onclick="startGDriveAuth()" style="padding: 12px 25px; background: #4285f4; color: white; border: none; border-radius: 8px; cursor: pointer; font-size: 1rem; margin-bottom: 15px;">
        <i class="fas fa-lock"></i> Authorize with Google
      </button>
      
      <div id="authCodeSection" style="display: none; margin-top: 15px;">
        <p>After authorizing, paste the code here:</p>
        <input type="text" id="gdriveAuthCode" placeholder="Paste authorization code here" 
               style="width: 100%; padding: 10px; border-radius: 8px; border: 1px solid #ccc; margin: 10px 0;">
        <button onclick="completeGDriveAuth()" style="padding: 12px 25px; background: #0f9d58; color: white; border: none; border-radius: 8px; cursor: pointer;">
          <i class="fas fa-check"></i> Complete Setup
        </button>
      </div>
    </div>
  </div>
</div>

<!-- Medicine Return Modal -->
<div class="return-modal-overlay" id="returnModal">
  <div class="return-modal">
    <div class="return-header">
      <h3><i class="fas fa-undo-alt"></i> Medicine Return</h3>
      <span class="return-close" onclick="closeReturnModal()">&times;</span>
    </div>
    
    <div class="return-content">
      <!-- Customer Info (Optional) -->
      <div class="return-customer-info">
        <input type="text" id="returnCustomerName" placeholder="Customer Name (optional)">
        <input type="text" id="returnCustomerPhone" placeholder="Phone (optional)">
      </div>
      
      <!-- Medicine Search -->
      <div class="return-search">
        <input type="text" id="returnMedicineSearch" placeholder="Search medicine name..." oninput="searchMedicineForReturn()">
      </div>
      
      <div id="medicineSearchResults" class="medicine-search-dropdown" style="display: none;">
        <!-- Search results will appear here -->
      </div>
      
      <h4 style="margin: 15px 0 10px; color: #28a745;"><i class="fas fa-pills"></i> Medicines to Return</h4>
      <div class="return-items-list" id="returnItemsList">
        <div class="no-items-msg">
          <i class="fas fa-info-circle"></i> Search and add medicines to return
        </div>
      </div>
      
      <!-- Return Reason -->
      <div class="return-reason-section">
        <label><i class="fas fa-comment-alt"></i> Return Reason</label>
        <select id="returnReason">
          <option value="wrong_medicine">Wrong Medicine Given</option>
          <option value="expired">Expired Medicine</option>
          <option value="damaged">Damaged Package</option>
          <option value="allergy">Patient Allergy</option>
          <option value="doctor_changed">Doctor Changed Prescription</option>
          <option value="extra">Extra Medicine (Not Needed)</option>
          <option value="other">Other Reason</option>
        </select>
        <textarea id="returnReasonDetail" placeholder="Additional details (optional)..."></textarea>
      </div>
      
      <!-- Refund Summary -->
      <div class="refund-summary">
        <div class="refund-row">
          <span>Total Refund Amount:</span>
          <span id="totalRefundAmount" class="refund-amount">Rs. 0.00</span>
        </div>
      </div>
      
      <!-- Process Return Button -->
      <button class="btn-process-return" onclick="processReturn()">
        <i class="fas fa-check-circle"></i> Process Return
      </button>
    </div>
  </div>
</div>

<style>
/* Medicine Return Modal Styles */
.return-modal-overlay {
  display: none;
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background: rgba(0, 0, 0, 0.8);
  backdrop-filter: blur(5px);
  z-index: 2500;
  justify-content: center;
  align-items: center;
}

.return-modal-overlay.active {
  display: flex;
}

.return-modal {
  background: linear-gradient(135deg, #0d2818 0%, #1a472a 100%);
  border-radius: 20px;
  width: 95%;
  max-width: 550px;
  max-height: 90vh;
  display: flex;
  flex-direction: column;
  box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5);
  border: 1px solid rgba(40, 167, 69, 0.3);
  overflow: hidden;
}

.return-header {
  padding: 20px;
  background: linear-gradient(135deg, #28a745 0%, #1e7e34 100%);
  display: flex;
  justify-content: space-between;
  align-items: center;
  color: white;
}

.return-header h3 {
  margin: 0;
  font-size: 1.3rem;
}

.return-close {
  font-size: 28px;
  cursor: pointer;
  color: white;
  line-height: 1;
}

.return-close:hover {
  color: #a5d6a7;
}

.return-content {
  padding: 20px;
  overflow-y: auto;
  flex: 1;
}

.return-customer-info {
  display: grid;
  grid-template-columns: 1fr 1fr;
  gap: 10px;
  margin-bottom: 15px;
}

.return-customer-info input {
  padding: 10px 12px;
  border: 1px solid rgba(255, 255, 255, 0.2);
  border-radius: 8px;
  background: rgba(255, 255, 255, 0.1);
  color: white;
  font-size: 0.9rem;
}

.return-customer-info input::placeholder {
  color: #888;
}

.return-search {
  margin-bottom: 10px;
}

.return-search input {
  width: 100%;
  padding: 12px 15px;
  border: 1px solid rgba(255, 255, 255, 0.2);
  border-radius: 10px;
  background: rgba(255, 255, 255, 0.1);
  color: white;
  font-size: 1rem;
}

.return-search input::placeholder {
  color: #888;
}

.return-items-list {
  background: rgba(0, 0, 0, 0.2);
  border-radius: 12px;
  padding: 10px;
  max-height: 200px;
  overflow-y: auto;
  min-height: 80px;
}

.return-item {
  display: flex;
  align-items: center;
  gap: 10px;
  padding: 12px;
  background: rgba(255, 255, 255, 0.05);
  border-radius: 8px;
  margin-bottom: 8px;
  color: white;
}

.return-item:last-child {
  margin-bottom: 0;
}

.return-item-info {
  flex: 1;
}

.return-item-name {
  font-weight: 600;
  color: #4CAF50;
}

.return-item-details {
  font-size: 0.85rem;
  color: #aaa;
}

.return-item-qty {
  display: flex;
  align-items: center;
  gap: 8px;
}

.return-item-qty input {
  width: 60px;
  padding: 8px;
  border: 1px solid rgba(255, 255, 255, 0.2);
  border-radius: 6px;
  background: rgba(255, 255, 255, 0.1);
  color: white;
  text-align: center;
}

.return-item-price {
  font-weight: 600;
  color: #ff9800;
  min-width: 80px;
  text-align: right;
}

.return-reason-section {
  margin-top: 15px;
}

.return-reason-section label {
  display: block;
  color: #aaa;
  margin-bottom: 8px;
  font-size: 0.9rem;
}

.return-reason-section select {
  width: 100%;
  padding: 10px;
  border: 1px solid rgba(255, 255, 255, 0.2);
  border-radius: 8px;
  background: rgba(255, 255, 255, 0.1);
  color: white;
  font-size: 0.95rem;
  margin-bottom: 10px;
}

.return-reason-section select option {
  background: #0d2818;
  color: white;
}

.return-reason-section textarea {
  width: 100%;
  padding: 10px;
  border: 1px solid rgba(255, 255, 255, 0.2);
  border-radius: 8px;
  background: rgba(255, 255, 255, 0.1);
  color: white;
  font-size: 0.9rem;
  min-height: 50px;
  resize: vertical;
}

.refund-summary {
  margin-top: 15px;
  padding: 15px;
  background: linear-gradient(135deg, rgba(40, 167, 69, 0.2) 0%, rgba(30, 126, 52, 0.2) 100%);
  border-radius: 12px;
  border: 1px solid rgba(40, 167, 69, 0.3);
}

.refund-row {
  display: flex;
  justify-content: space-between;
  align-items: center;
  color: white;
}

.refund-amount {
  font-size: 1.5rem;
  font-weight: 700;
  color: #28a745;
}

.btn-process-return {
  width: 100%;
  padding: 15px;
  margin-top: 15px;
  border: none;
  border-radius: 12px;
  background: linear-gradient(135deg, #28a745 0%, #1e7e34 100%);
  color: white;
  font-size: 1.1rem;
  font-weight: 600;
  cursor: pointer;
  transition: all 0.3s ease;
}

.btn-process-return:hover {
  transform: translateY(-2px);
  box-shadow: 0 5px 20px rgba(40, 167, 69, 0.4);
}

.no-items-msg {
  text-align: center;
  padding: 20px;
  color: #888;
}

.medicine-search-dropdown {
  max-height: 180px;
  overflow-y: auto;
  background: #0d2818;
  border: 1px solid rgba(40, 167, 69, 0.3);
  border-radius: 10px;
  margin-top: -5px;
  margin-bottom: 10px;
}

.medicine-search-item {
  padding: 12px 15px;
  cursor: pointer;
  color: white;
  border-bottom: 1px solid rgba(255, 255, 255, 0.1);
  transition: background 0.2s;
}

.medicine-search-item:hover {
  background: rgba(255, 255, 255, 0.1);
}

.medicine-search-item:last-child {
  border-bottom: none;
}

.remove-return-item {
  background: #dc3545;
  color: white;
  border: none;
  border-radius: 6px;
  padding: 6px 10px;
  cursor: pointer;
  font-size: 0.8rem;
}
</style>

<style>
/* Google Drive Setup Modal */
.gdrive-setup-modal {
  display: none;
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background: rgba(0, 0, 0, 0.8);
  z-index: 3000;
  justify-content: center;
  align-items: center;
}

.gdrive-setup-modal.active {
  display: flex;
}

.gdrive-setup-content {
  background: white;
  padding: 30px;
  border-radius: 15px;
  max-width: 500px;
  width: 90%;
  max-height: 80vh;
  overflow-y: auto;
  position: relative;
  color: #333;
}

.close-gdrive-setup {
  position: absolute;
  top: 15px;
  right: 20px;
  font-size: 28px;
  cursor: pointer;
  color: #666;
}

.close-gdrive-setup:hover {
  color: #333;
}

/* Settings Modal Styles */
.settings-modal-overlay {
  display: none;
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background: rgba(0, 0, 0, 0.7);
  backdrop-filter: blur(5px);
  z-index: 2000;
  justify-content: center;
  align-items: center;
}

.settings-modal-overlay.active {
  display: flex;
}

.settings-modal {
  background: linear-gradient(135deg, #1a472a 0%, #2d5016 100%);
  border-radius: 20px;
  width: 90%;
  max-width: 500px;
  max-height: 85vh;
  display: flex;
  flex-direction: column;
  box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5);
  border: 1px solid rgba(255, 255, 255, 0.1);
  overflow: hidden;
}

.settings-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 15px 20px;
  background: rgba(0, 0, 0, 0.2);
  border-bottom: 1px solid rgba(255, 255, 255, 0.1);
  flex-shrink: 0;
}

.settings-header h3 {
  margin: 0;
  font-size: 1.2rem;
  color: white;
}

.settings-close {
  font-size: 1.8rem;
  cursor: pointer;
  color: rgba(255, 255, 255, 0.7);
  transition: all 0.3s;
  line-height: 1;
}

.settings-close:hover {
  color: #ff6b6b;
  transform: scale(1.1);
}

.settings-content {
  padding: 15px 20px;
  overflow-y: auto;
  flex: 1;
}

.settings-section {
  margin-bottom: 15px;
  padding: 15px;
  background: rgba(0, 0, 0, 0.2);
  border-radius: 10px;
  border: 1px solid rgba(255, 255, 255, 0.1);
}

.settings-section:last-child {
  margin-bottom: 0;
}

.settings-section h4 {
  margin: 0 0 8px 0;
  font-size: 1rem;
  color: #8BC34A;
}

.settings-desc {
  font-size: 0.85rem;
  color: rgba(255, 255, 255, 0.7);
  margin: 0 0 10px 0;
}

.settings-warning {
  font-size: 0.8rem;
  color: #ff9800;
  margin: 0 0 10px 0;
  padding: 8px;
  background: rgba(255, 152, 0, 0.1);
  border-radius: 6px;
  border-left: 3px solid #ff9800;
}

.db-info {
  background: rgba(0, 0, 0, 0.2);
  border-radius: 6px;
  padding: 10px;
}

.db-info-row {
  display: flex;
  justify-content: space-between;
  padding: 5px 0;
  border-bottom: 1px solid rgba(255, 255, 255, 0.1);
}

.db-info-row:last-child {
  border-bottom: none;
}

.db-label {
  color: rgba(255, 255, 255, 0.6);
  font-size: 0.8rem;
}

.db-value {
  color: white;
  font-size: 0.8rem;
  font-weight: 500;
  word-break: break-all;
  text-align: right;
  max-width: 60%;
}

.settings-btn {
  width: 100%;
  padding: 10px 15px;
  border: none;
  border-radius: 8px;
  font-size: 0.9rem;
  font-weight: 600;
  cursor: pointer;
  display: flex;
  align-items: center;
  justify-content: center;
  gap: 8px;
  transition: all 0.3s ease;
}

.backup-btn {
  background: linear-gradient(135deg, #4CAF50, #2E7D32);
  color: white;
}

.backup-btn:hover {
  background: linear-gradient(135deg, #66BB6A, #388E3C);
  transform: translateY(-2px);
  box-shadow: 0 4px 15px rgba(76, 175, 80, 0.4);
}

.restore-btn {
  background: linear-gradient(135deg, #FF9800, #F57C00);
  color: white;
}

.restore-btn:hover {
  background: linear-gradient(135deg, #FFB74D, #FF9800);
  transform: translateY(-2px);
  box-shadow: 0 4px 15px rgba(255, 152, 0, 0.4);
}

.settings-btn span {
  font-size: 1rem;
}

/* Custom Scrollbar for Settings */
.settings-content::-webkit-scrollbar {
  width: 8px;
}

.settings-content::-webkit-scrollbar-track {
  background: rgba(0, 0, 0, 0.2);
  border-radius: 4px;
}

.settings-content::-webkit-scrollbar-thumb {
  background: rgba(255, 255, 255, 0.3);
  border-radius: 4px;
}

.settings-content::-webkit-scrollbar-thumb:hover {
  background: rgba(255, 255, 255, 0.5);
}
</style>

<!-- Overlay -->
<div class="overlay" id="overlay"></div>

<!-- Popup Modal -->
<div class="popup-overlay" id="popup">
  <div class="popup-box">
    <div class="tick">✔</div>
    <div>Order processed successfully! Please check your printer.</div>
  </div>
</div>

<!-- Thermal Receipt (Hidden, only shows when printing) -->
<div class="thermal-receipt" id="thermalReceipt">
  <div class="header">
    <div class="clinic-name" style="color: #000 !important; font-weight: 900 !important;">ZOONA CHILD CARE CLINIC</div>
    <div class="dept-name" style="color: #000 !important; font-weight: 900 !important;">Pharmacy Department</div>
    <div class="receipt-title" style="color: #000 !important; font-weight: 900 !important;">RECEIPT</div>
  </div>
  
  <div class="info-line" style="color: #000 !important; font-weight: 900 !important;">
    <span style="color: #000 !important; font-weight: 900 !important;">Date:</span>
    <span id="receiptDate" style="color: #000 !important; font-weight: 900 !important;"></span>
  </div>
  <div class="info-line" style="color: #000 !important; font-weight: 900 !important;">
    <span style="color: #000 !important; font-weight: 900 !important;">Time:</span>
    <span id="receiptTime" style="color: #000 !important; font-weight: 900 !important;"></span>
  </div>
  <div class="info-line" style="color: #000 !important; font-weight: 900 !important;">
    <span style="color: #000 !important; font-weight: 900 !important;">Patient:</span>
    <span id="receiptPatient" style="color: #000 !important; font-weight: 900 !important;"></span>
  </div>
  <div class="info-line" style="color: #000 !important; font-weight: 900 !important;">
    <span style="color: #000 !important; font-weight: 900 !important;">Ref No:</span>
    <span id="receiptRefNo" style="color: #000 !important; font-weight: 900 !important;"></span>
  </div>
  
  <div class="section-title" style="color: #000 !important; font-weight: 900 !important;">ITEMS</div>
  <div id="receiptItems"></div>
  
  <div class="totals">
    <div class="total-line" style="color: #000 !important; font-weight: 900 !important;">
      <span style="color: #000 !important; font-weight: 900 !important;">Subtotal:</span>
      <span id="receiptSubtotal" style="color: #000 !important; font-weight: 900 !important;"></span>
    </div>
    <div class="total-line discount-line" id="receiptDiscountLine" style="display: none; color: #000 !important; font-weight: 900 !important;">
      <span id="receiptDiscountLabel" style="color: #000 !important; font-weight: 900 !important;"></span>
      <span id="receiptDiscount" style="color: #000 !important; font-weight: 900 !important;"></span>
    </div>
    <div class="total-line grand-total" style="color: #000 !important; font-weight: 900 !important;">
      <span style="color: #000 !important; font-weight: 900 !important;">TOTAL:</span>
      <span id="receiptGrandTotal" style="color: #000 !important; font-weight: 900 !important;"></span>
    </div>
  </div>
  
  <div class="footer">
    <div class="thank-you" style="color: #000 !important; font-weight: 900 !important;">Thank You!</div>
    <div style="color: #000 !important; font-weight: 900 !important;">For any queries, please contact</div>
    <div style="color: #000 !important; font-weight: 900 !important;">pharmacy department</div>
  </div>
</div>

{% endblock content %}


{% block js %}
<script>
    // Global variables
    let currentPatient = null;
    let currentPrescriptions = [];
    let discountAmount = 0;
    let discountPercentage = 0;
    let directSaleMode = false;
    let searchTimeout = null;

    // Toggle Direct Sale Mode
    function toggleDirectSale() {
        directSaleMode = !directSaleMode;
        const modeIndicator = document.getElementById('modeIndicator');
        const addMedicineSection = document.getElementById('addMedicineSection');
        const toggleBtn = document.getElementById('directSaleToggle');
        
        if (directSaleMode) {
            modeIndicator.style.display = 'block';
            addMedicineSection.style.display = 'block';
            toggleBtn.innerHTML = '<i class="fas fa-clipboard-list"></i> Prescription Mode';
            toggleBtn.style.background = 'linear-gradient(135deg, #2196F3 0%, #1565C0 100%)';
            
            // Clear current data and allow adding medicines
            document.getElementById('prescriptionRows').innerHTML = '';
            document.getElementById('searchStatus').style.display = 'none';
            
            // Auto-add first medicine row and focus on it after a delay
            addMedicineRow();
            
            // Focus on medicine input after modal closes
            setTimeout(() => {
                const firstMedicineInput = document.querySelector('#prescriptionRows .medicine-input');
                if (firstMedicineInput) {
                    firstMedicineInput.focus();
                    firstMedicineInput.click();
                }
            }, 500);
            
            Modal.info('Direct Sale Mode - Add medicines manually.', 'Direct Sale', 1500);
        } else {
            modeIndicator.style.display = 'none';
            addMedicineSection.style.display = 'none';
            toggleBtn.innerHTML = '<i class="fas fa-shopping-cart"></i> Direct Sale';
            toggleBtn.style.background = '';
            
            // Clear data
            resetForm();
            Modal.info('Prescription Mode - Search patient to load prescriptions.', 'Prescription Mode', 2000);
        }
    }
    // Add new medicine row (for direct sale)
    function addMedicineRow() {
        const tbody = document.getElementById('prescriptionRows');
        const rowIndex = tbody.children.length;
        
        const row = document.createElement('tr');
        row.innerHTML = `
            <td>
                <div class="medicine-search-wrapper">
                    <input type="text" 
                           class="medicine-input" 
                           placeholder="Search..."
                           style="background: rgba(255, 255, 255, 0.15); cursor: text;"
                           data-medicine-id=""
                           data-medicine-form="tablet"
                           data-sale-price="0"
                           data-subitem-price="0"
                           autocomplete="off"
                           onkeyup="searchMedicine(this)">
                    <div class="autocomplete-results"></div>
                </div>
            </td>
            <td>
                <input type="number" 
                       value="1" 
                       class="qty-input small-input" 
                       min="1">
            </td>
            <td>
                <select class="dosage-form-select">
                    <option value="MG">MG</option>
                    <option value="CC">CC</option>
                    <option value="ML">ML</option>
                    <option value="TABLETS" selected>Tablets</option>
                    <option value="CAPSULES">Capsules</option>
                    <option value="DROPS">Drops</option>
                    <option value="TSP">Teaspoon</option>
                    <option value="TBSP">Tablespoon</option>
                    <option value="SACHET">Sachet</option>
                    <option value="PUFF">Puff</option>
                    <option value="UNIT">Unit</option>
                </select>
            </td>
            <td>
                <select class="frequency-select" onchange="updateUrduInRow(this); recalculateRowPrice(this)">
                    <option value="OD">OD</option>
                    <option value="BD">BD</option>
                    <option value="TDS">TDS</option>
                    <option value="QID">QID</option>
                    <option value="HS">HS</option>
                    <option value="QAM">QAM</option>
                    <option value="QPM">QPM</option>
                    <option value="SOS">SOS</option>
                    <option value="STAT">STAT</option>
                    <option value="QOD">QOD</option>
                    <option value="QW">QW</option>
                    <option value="Q6H">Q6H</option>
                    <option value="Q8H">Q8H</option>
                    <option value="AC">AC</option>
                    <option value="PC">PC</option>
                </select>
            </td>
            <td>
                <span class="urdu-display" style="display: block; padding: 5px; background: rgba(0, 0, 0, 0.2); border-radius: 4px; font-size: 0.85rem; text-align: right; direction: rtl; font-family: 'Jameel Noori Nastaleeq', Arial, sans-serif;">
                    روزانہ ایک بار
                </span>
            </td>
            <td>
                <input type="number" 
                       value="1" 
                       class="days-input small-input" 
                       min="1"
                       max="365"
                       onchange="recalculateRowPrice(this)">
            </td>
            <td>
                <input type="number" 
                       value="0.00" 
                       class="price-input small-input" 
                       step="0.01"
                       min="0"
                       onchange="calculateBill()">
            </td>
            <td style="text-align: center;">
                <button type="button" 
                        onclick="removeRow(this)" 
                        style="background: #ff4444; color: white; border: none; border-radius: 4px; padding: 4px 6px; cursor: pointer; font-size: 11px;"
                        title="Remove">
                    ✕
                </button>
            </td>
        `;
        tbody.appendChild(row);
        
        // Focus on the medicine search input of the new row
        setTimeout(() => {
            const medicineInput = row.querySelector('.medicine-input');
            if (medicineInput) {
                medicineInput.focus();
            }
        }, 100);
    }
    
    // Recalculate price when days or frequency changes
    function recalculateRowPrice(element) {
        const row = element.closest('tr');
        const medicineInput = row.querySelector('.medicine-input');
        
        if (!medicineInput.dataset.medicineId) return;
        
        const medicineForm = medicineInput.dataset.medicineForm || 'tablet';
        const salePrice = parseFloat(medicineInput.dataset.salePrice) || 0;
        const subitemPrice = parseFloat(medicineInput.dataset.subitemPrice) || 0;
        
        autoCalculatePrice(row, medicineForm, salePrice, subitemPrice);
    }
    
    // Update Urdu text when frequency changes
    function updateUrduInRow(select) {
        const row = select.closest('tr');
        const urduSpan = row.querySelector('.urdu-display');
        const frequencyUrdu = {
            'OD': 'روزانہ ایک بار',
            'BD': 'دن میں دو بار',
            'TDS': 'دن میں تین بار',
            'QID': 'دن میں چار بار',
            'HS': 'سوتے وقت',
            'QAM': 'صبح میں',
            'QPM': 'شام میں',
            'SOS': 'ضرورت کے وقت',
            'STAT': 'فوری طور پر',
            'QOD': 'ایک دن چھوڑ کر',
            'QW': 'ہفتے میں ایک بار',
            'Q6H': 'ہر 6 گھنٹے',
            'Q8H': 'ہر 8 گھنٹے',
            'AC': 'کھانے سے پہلے',
            'PC': 'کھانے کے بعد'
        };
        if (urduSpan) {
            urduSpan.textContent = frequencyUrdu[select.value] || select.value;
        }
    }

    // Search medicine for autocomplete
    function searchMedicine(input) {
        const query = input.value.trim();
        const wrapper = input.closest('.medicine-search-wrapper');
        const resultsDiv = wrapper.querySelector('.autocomplete-results');
        
        if (searchTimeout) {
            clearTimeout(searchTimeout);
        }
        
        if (query.length < 1) {
            resultsDiv.classList.remove('show');
            return;
        }
        
        searchTimeout = setTimeout(() => {
            fetch(`/pharmacy/api/search-medicines/?q=${encodeURIComponent(query)}`)
                .then(response => response.json())
                .then(data => {
                    if (data.success && data.medicines.length > 0) {
                        let html = '';
                        data.medicines.forEach(medicine => {
                            const stockInfo = medicine.medicine_form === 'syrup' || medicine.medicine_form === 'drops' 
                                ? `${medicine.stock} bottles` 
                                : `${medicine.stock} tablets`;
                            html += `
                                <div class="autocomplete-item" 
                                     data-id="${medicine.id}" 
                                     data-name="${medicine.name}"
                                     data-dosage="${medicine.dosage || ''}"
                                     data-form="${medicine.medicine_form || 'tablet'}"
                                     data-price="${medicine.sale_price || 0}"
                                     data-subitem-price="${medicine.sale_price_per_subitem || 0}"
                                     onclick="selectMedicine(this)">
                                    <div class="med-name">${medicine.name}</div>
                                    <div class="med-info">${medicine.medicine_form || 'tablet'} | Stock: ${stockInfo} | Rs. ${medicine.sale_price_per_subitem || medicine.sale_price || 0}/unit</div>
                                </div>
                            `;
                        });
                        resultsDiv.innerHTML = html;
                        resultsDiv.classList.add('show');
                    } else {
                        resultsDiv.innerHTML = '<div class="autocomplete-item empty">No medicines found</div>';
                        resultsDiv.classList.add('show');
                    }
                })
                .catch(error => {
                    console.error('Search error:', error);
                    resultsDiv.classList.remove('show');
                });
        }, 300);
    }

    // Select medicine from autocomplete
    function selectMedicine(item) {
        const wrapper = item.closest('.medicine-search-wrapper');
        const input = wrapper.querySelector('.medicine-input');
        const resultsDiv = wrapper.querySelector('.autocomplete-results');
        const row = item.closest('tr');
        
        input.value = item.dataset.name;
        input.dataset.medicineId = item.dataset.id;
        input.dataset.medicineForm = item.dataset.form;
        input.dataset.salePrice = item.dataset.price || '0';
        input.dataset.subitemPrice = item.dataset.subitemPrice || '0';
        
        resultsDiv.classList.remove('show');
        
        // Auto-fill QTY from medicine name or dosage field (e.g., "400" from "Brufen 400mg" or "400mg")
        const medicineName = item.dataset.name || '';
        const dosage = item.dataset.dosage || '';
        const combinedText = medicineName + ' ' + dosage;
        const qtyMatch = combinedText.match(/(\d+)\s*(mg|ml|g|mcg)/i);
        const qtyInput = row.querySelector('.qty-input');
        if (qtyMatch && qtyInput) {
            qtyInput.value = qtyMatch[1];
        }
        
        // Auto-select dosage form based on medicine form
        const dosageFormSelect = row.querySelector('.dosage-form-select');
        if (dosageFormSelect) {
            const form = item.dataset.form || 'tablet';
            const formMap = {
                'tablet': 'TABLETS',
                'capsule': 'CAPSULES',
                'syrup': 'ML',
                'drops': 'DROPS',
                'injection': 'ML',
                'cream': 'MG',
                'ointment': 'MG'
            };
            const mappedForm = formMap[form.toLowerCase()] || 'TABLETS';
            dosageFormSelect.value = mappedForm;
        }
        
        // Auto-fill price based on frequency and days
        autoCalculatePrice(row, item.dataset.form, parseFloat(item.dataset.price) || 0, parseFloat(item.dataset.subitemPrice) || 0);
    }
    
    // Auto calculate price based on frequency, days and medicine form
    function autoCalculatePrice(row, medicineForm, salePrice, subitemPrice) {
        const daysInput = row.querySelector('.days-input');
        const frequencySelect = row.querySelector('.frequency-select');
        const priceInput = row.querySelector('.price-input');
        
        const days = parseInt(daysInput?.value) || 1;
        const frequency = frequencySelect?.value || 'OD';
        
        // Calculate doses per day based on frequency
        const frequencyMap = { 'OD': 1, 'BD': 2, 'TDS': 3, 'QID': 4, 'HS': 1, 'SOS': 1 };
        const dosesPerDay = frequencyMap[frequency] || 1;
        
        const LIQUID_FORMS = ['syrup', 'drops', 'injection', 'inhaler', 'ointment'];
        
        if (LIQUID_FORMS.includes((medicineForm || '').toLowerCase())) {
            // Bottles calculation
            const bottles = Math.max(1, Math.ceil(days / 7));
            const pricePerBottle = salePrice || 0;
            if (priceInput) priceInput.value = Math.round(bottles * pricePerBottle);
        } else {
            // Tablets calculation
            const totalTablets = dosesPerDay * days;
            const pricePerTablet = subitemPrice || 0;
            if (priceInput) priceInput.value = Math.round(totalTablets * pricePerTablet);
        }
        
        calculateBill();
    }

    // Update quantity and price when days or timing changes
    function updateQuantityAndPrice(element) {
        const row = element.closest('tr');
        const medicineInput = row.querySelector('.medicine-input');
        const daysInput = row.querySelector('.days-input');
        const timingSelect = row.querySelector('.timing-select');
        const qtyLabel = row.querySelector('.qty-label');
        const qtyInput = row.querySelector('.quantity-input');
        const priceInput = row.querySelector('.price-input');
        
        if (!medicineInput.dataset.medicineId) return;
        
        const days = parseInt(daysInput.value) || 1;
        const timing = timingSelect ? timingSelect.value : 'morning,evening';
        const medicineForm = medicineInput.dataset.medicineForm || 'tablet';
        
        // Calculate doses per day
        let dosesPerDay = timing.split(',').length;
        
        // Get prices from search API (we stored them in dataset)
        // For now, fetch fresh data
        fetch(`/pharmacy/api/search-medicines/?q=${encodeURIComponent(medicineInput.value)}`)
            .then(response => response.json())
            .then(data => {
                if (data.success && data.medicines.length > 0) {
                    const medicine = data.medicines.find(m => m.id == medicineInput.dataset.medicineId) || data.medicines[0];
                    
                    const LIQUID_FORMS = ['syrup', 'drops', 'injection', 'inhaler', 'ointment'];
                    
                    if (LIQUID_FORMS.includes(medicineForm)) {
                        // Bottles calculation
                        const bottles = Math.max(1, Math.ceil(days / 7));
                        qtyLabel.textContent = `${bottles} bottle(s)`;
                        qtyInput.value = bottles;
                        
                        const pricePerBottle = parseFloat(medicine.sale_price) || 0;
                        priceInput.value = Math.round(bottles * pricePerBottle);
                    } else {
                        // Tablets calculation
                        const totalTablets = dosesPerDay * days;
                        qtyLabel.textContent = `${totalTablets} tablet(s)`;
                        qtyInput.value = totalTablets;
                        
                        const pricePerTablet = parseFloat(medicine.sale_price_per_subitem) || 0;
                        priceInput.value = Math.round(totalTablets * pricePerTablet);
                    }
                    
                    calculateBill();
                }
            })
            .catch(error => console.error('Price update error:', error));
    }

    // Close autocomplete when clicking outside
    document.addEventListener('click', function(e) {
        if (!e.target.closest('.medicine-search-wrapper')) {
            document.querySelectorAll('.autocomplete-results').forEach(div => {
                div.classList.remove('show');
            });
        }
    });

    // ========== MENU PASSWORD LOCK FUNCTIONS ==========
    function showPasswordPrompt() {
      document.getElementById('menuPasswordOverlay').style.display = 'flex';
      document.getElementById('menuPasswordInput').value = '';
      document.getElementById('menuPasswordInput').focus();
      document.getElementById('passwordError').style.display = 'none';
    }
    
    function closePasswordPrompt() {
      document.getElementById('menuPasswordOverlay').style.display = 'none';
    }
    
    function verifyMenuPassword() {
      const password = document.getElementById('menuPasswordInput').value;
      
      fetch('/api/verify-menu-password/', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ password: password, role: 'pharmacy' })
      })
      .then(response => response.json())
      .then(data => {
        if (data.success) {
          closePasswordPrompt();
          // Open the menu
          sideMenu.classList.add("active");
          overlay.classList.add("active");
        } else {
          document.getElementById('passwordError').style.display = 'block';
          document.getElementById('passwordErrorText').textContent = data.error || 'Invalid password';
          document.getElementById('menuPasswordInput').value = '';
          document.getElementById('menuPasswordInput').focus();
        }
      })
      .catch(err => {
        document.getElementById('passwordError').style.display = 'block';
        document.getElementById('passwordErrorText').textContent = 'Connection error';
      });
    }

    // ✅ Menu toggle with password protection
    const hamburger = document.getElementById("hamburger");
    const sideMenu = document.getElementById("sideMenu");
    const overlay = document.getElementById("overlay");
    const closeMenu = document.getElementById("closeMenu");

    hamburger.addEventListener("click", () => {
      showPasswordPrompt();
    });

    closeMenu.addEventListener("click", () => {
      sideMenu.classList.remove("active");
      overlay.classList.remove("active");
    });

    overlay.addEventListener("click", () => {
      sideMenu.classList.remove("active");
      overlay.classList.remove("active");
    });

    // Search patient and load prescriptions
    function searchPrescription() {
        const refNo = document.getElementById('refNoInput').value.trim();
        const searchStatus = document.getElementById('searchStatus');
        
        if (!refNo) {
            Modal.warning('Please enter a patient reference number or name!', 'Search Required');
            return;
        }
        
        // Show loading
        Modal.loading('Searching patient and prescriptions...', 'Please Wait');
        searchStatus.style.display = 'none';
        
        fetch(`/pharmacy/api/search-patient/?q=${encodeURIComponent(refNo)}`)
            .then(response => response.json())
            .then(data => {
                Modal.close();
                
                if (data.success) {
                    currentPatient = data.patient;
                    currentPrescriptions = data.prescriptions;
                    
                    // Show success message
                    searchStatus.innerHTML = `<i class="fas fa-check-circle"></i> Found ${data.total_medicines} prescription(s) for ${data.patient.name}`;
                    searchStatus.style.display = 'block';
                    searchStatus.style.background = 'rgba(76, 175, 80, 0.3)';
                    searchStatus.style.color = 'white';
                    
                    // Load prescriptions into table
                    loadPrescriptionsToTable(data.prescriptions);
                    
                    // Show Add Medicine button so pharmacist can add more medicines
                    document.getElementById('addMedicineSection').style.display = 'block';
                    
                    // Update patient details with modern layout
                    updatePatientDetails(data.patient);
                    
                    // Calculate and show bill
                    calculateBill();
                    
                    Modal.success(`Found ${data.total_medicines} prescribed medicine(s) for <strong>${data.patient.name}</strong>`, 'Prescriptions Loaded', 3000);
                } else {
                    searchStatus.innerHTML = '<i class="fas fa-times-circle"></i> ' + data.error;
                    searchStatus.style.display = 'block';
                    searchStatus.style.background = 'rgba(244, 67, 54, 0.3)';
                    searchStatus.style.color = 'white';
                    
                    // Clear table only if not in direct sale mode
                    if (!directSaleMode) {
                        document.getElementById('prescriptionRows').innerHTML = '';
                    }
                    
                    // If patient found but no prescriptions
                    if (data.patient) {
                        currentPatient = data.patient;
                        updatePatientDetails(data.patient);
                        
                        if (directSaleMode) {
                            // In direct sale mode, allow adding medicines without prescription
                            searchStatus.innerHTML = `<i class="fas fa-check-circle"></i> Patient found: ${data.patient.name} (No prescription - Direct Sale Mode)`;
                            searchStatus.style.background = 'rgba(255, 152, 0, 0.3)';
                            Modal.info(`Patient <strong>${data.patient.name}</strong> found but has no prescriptions.<br><br>In Direct Sale Mode, you can add medicines manually.`, 'Patient Found', 3000);
                        } else {
                            Modal.warning('This patient has no prescriptions yet. Please ask them to visit the doctor first, or switch to Direct Sale Mode.', 'No Prescriptions');
                        }
                    } else {
                        resetPatientDetails();
                        Modal.error(data.error, 'Patient Not Found');
                    }
                    
                    // Reset bill
                    resetBillContent();
                }
            })
            .catch(error => {
                Modal.close();
                console.error('Search error:', error);
                Modal.error('Failed to search patient. Please check your connection and try again.', 'Search Failed');
                
                searchStatus.innerHTML = '<i class="fas fa-times-circle"></i> Connection error';
                searchStatus.style.display = 'block';
                searchStatus.style.background = 'rgba(244, 67, 54, 0.3)';
                searchStatus.style.color = 'white';
            });
    }

    // Load prescriptions into the table
    function loadPrescriptionsToTable(prescriptions) {
        const tbody = document.getElementById('prescriptionRows');
        tbody.innerHTML = '';
        
        prescriptions.forEach((rx, index) => {
            const row = document.createElement('tr');
            row.innerHTML = `
                <td>
                    <div class="medicine-search-wrapper">
                        <input type="text" 
                               value="${rx.medicine_name}" 
                               class="medicine-input" 
                               placeholder="Medicine"
                               style="background: rgba(255, 255, 255, 0.15); cursor: text;"
                               data-medicine-id="${rx.medicine_id}"
                               data-original-name="${rx.medicine_name}"
                               data-medicine-form="${rx.medicine_form || 'tablet'}"
                               data-sale-price="0"
                               data-subitem-price="0"
                               autocomplete="off"
                               onkeyup="searchMedicine(this)">
                        <div class="autocomplete-results"></div>
                    </div>
                </td>
                <td>
                    <input type="number" 
                           value="${rx.qty || 1}" 
                           class="qty-input small-input" 
                           min="1">
                </td>
                <td>
                    <select class="dosage-form-select">
                        <option value="MG" ${rx.dosage_form === 'MG' ? 'selected' : ''}>MG</option>
                        <option value="CC" ${rx.dosage_form === 'CC' ? 'selected' : ''}>CC</option>
                        <option value="ML" ${rx.dosage_form === 'ML' ? 'selected' : ''}>ML</option>
                        <option value="TABLETS" ${rx.dosage_form === 'TABLETS' ? 'selected' : ''}>Tablets</option>
                        <option value="CAPSULES" ${rx.dosage_form === 'CAPSULES' ? 'selected' : ''}>Capsules</option>
                        <option value="DROPS" ${rx.dosage_form === 'DROPS' ? 'selected' : ''}>Drops</option>
                        <option value="TSP" ${rx.dosage_form === 'TSP' ? 'selected' : ''}>Teaspoon</option>
                        <option value="TBSP" ${rx.dosage_form === 'TBSP' ? 'selected' : ''}>Tablespoon</option>
                        <option value="SACHET" ${rx.dosage_form === 'SACHET' ? 'selected' : ''}>Sachet</option>
                        <option value="PUFF" ${rx.dosage_form === 'PUFF' ? 'selected' : ''}>Puff</option>
                        <option value="UNIT" ${rx.dosage_form === 'UNIT' ? 'selected' : ''}>Unit</option>
                    </select>
                </td>
                <td>
                    <select class="frequency-select" onchange="updateUrduInRow(this)">
                        <option value="OD" ${rx.frequency === 'OD' ? 'selected' : ''}>OD</option>
                        <option value="BD" ${rx.frequency === 'BD' ? 'selected' : ''}>BD</option>
                        <option value="TDS" ${rx.frequency === 'TDS' ? 'selected' : ''}>TDS</option>
                        <option value="QID" ${rx.frequency === 'QID' ? 'selected' : ''}>QID</option>
                        <option value="HS" ${rx.frequency === 'HS' ? 'selected' : ''}>HS</option>
                        <option value="QAM" ${rx.frequency === 'QAM' ? 'selected' : ''}>QAM</option>
                        <option value="QPM" ${rx.frequency === 'QPM' ? 'selected' : ''}>QPM</option>
                        <option value="SOS" ${rx.frequency === 'SOS' ? 'selected' : ''}>SOS</option>
                        <option value="STAT" ${rx.frequency === 'STAT' ? 'selected' : ''}>STAT</option>
                        <option value="QOD" ${rx.frequency === 'QOD' ? 'selected' : ''}>QOD</option>
                        <option value="QW" ${rx.frequency === 'QW' ? 'selected' : ''}>QW</option>
                        <option value="Q6H" ${rx.frequency === 'Q6H' ? 'selected' : ''}>Q6H</option>
                        <option value="Q8H" ${rx.frequency === 'Q8H' ? 'selected' : ''}>Q8H</option>
                        <option value="AC" ${rx.frequency === 'AC' ? 'selected' : ''}>AC</option>
                        <option value="PC" ${rx.frequency === 'PC' ? 'selected' : ''}>PC</option>
                    </select>
                </td>
                <td>
                    <span class="urdu-display" style="display: block; padding: 5px; background: rgba(0, 0, 0, 0.2); border-radius: 4px; font-size: 0.85rem; text-align: right; direction: rtl; font-family: 'Jameel Noori Nastaleeq', Arial, sans-serif;">
                        ${rx.frequency_urdu || 'روزانہ ایک بار'}
                    </span>
                </td>
                <td>
                    <input type="number" 
                           value="${rx.days}" 
                           class="days-input small-input" 
                           min="1"
                           max="365"
                           onchange="calculateBill()">
                </td>
                <td>
                    <input type="number" 
                           value="${Math.round(rx.price)}" 
                           class="price-input small-input" 
                           step="1"
                           min="0"
                           onchange="calculateBill()">
                </td>
                <td style="text-align: center;">
                    <button type="button" 
                            onclick="removeRow(this)" 
                            style="background: #ff4444; color: white; border: none; border-radius: 4px; padding: 4px 6px; cursor: pointer; font-size: 11px;"
                            title="Remove">
                        ✕
                    </button>
                </td>
            `;
            tbody.appendChild(row);
        });
    }
    
    // Remove a medicine row from the table
    function removeRow(button) {
        const row = button.closest('tr');
        row.remove();
        calculateBill();
        
        // Update prescriptions count
        const remainingRows = document.querySelectorAll('#prescriptionRows tr').length;
        const searchStatus = document.getElementById('searchStatus');
        if (remainingRows === 0) {
            searchStatus.textContent = 'All medicines removed from bill';
            searchStatus.style.background = 'rgba(255, 152, 0, 0.3)';
        } else {
            searchStatus.innerHTML = `<i class="fas fa-check-circle"></i> ${remainingRows} medicine(s) in bill for ${currentPatient?.name || 'patient'}`;
        }
    }

    // Calculate total bill
    function calculateBill() {
        const priceInputs = document.querySelectorAll('.price-input');
        let subtotal = 0;
        let itemsCount = 0;
        let billItemsHtml = '';
        
        priceInputs.forEach((input, index) => {
            const price = parseFloat(input.value) || 0;
            if (price > 0) {
                const row = input.closest('tr');
                const medicineInput = row.querySelector('.medicine-input');
                const daysInput = row.querySelector('.days-input');
                const qtyInput = row.querySelector('.qty-input');
                const medicineName = medicineInput.value;
                const days = daysInput ? daysInput.value : '1';
                const qty = qtyInput ? qtyInput.value : '1';
                
                subtotal += price;
                itemsCount++;
                billItemsHtml += `
                    <div class="bill-item">
                        <span class="bill-item-name">${medicineName}</span>
                        <span class="bill-item-qty">${days} days</span>
                        <span class="bill-item-price">Rs. ${price.toFixed(0)}</span>
                    </div>`;
            }
        });
        
        // Calculate final total with discount
        const finalTotal = subtotal - discountAmount;
        
        let billHtml = '';
        
        if (itemsCount > 0) {
            billHtml = `
                <div class="bill-items">${billItemsHtml}</div>
                <div class="bill-divider"></div>
                <div class="bill-summary-row">
                    <span>Items</span>
                    <span>${itemsCount}</span>
                </div>
                <div class="bill-summary-row">
                    <span>Subtotal</span>
                    <span>Rs. ${subtotal.toFixed(0)}</span>
                </div>`;
            
            if (discountAmount > 0) {
                billHtml += `
                <div class="bill-summary-row" style="color: #ff9800;">
                    <span>Discount (${discountPercentage.toFixed(1)}%)</span>
                    <span>- Rs. ${discountAmount.toFixed(0)}</span>
                </div>`;
            }
            
            billHtml += `
                <div class="bill-summary-row total">
                    <span>TOTAL</span>
                    <span>Rs. ${finalTotal.toFixed(0)}</span>
                </div>`;
        } else {
            billHtml = `
                <div class="bill-empty">
                    <i class="fas fa-shopping-cart"></i>
                    <p>No items added yet</p>
                    <small>Add medicines to see bill preview</small>
                </div>`;
        }
        
        document.getElementById('billContent').innerHTML = billHtml;
    }

    // Update discount from amount
    function updateDiscountFromAmount() {
        const amount = parseFloat(document.getElementById('discountAmount').value) || 0;
        
        // Calculate subtotal
        const priceInputs = document.querySelectorAll('.price-input');
        let subtotal = 0;
        priceInputs.forEach(input => {
            subtotal += parseFloat(input.value) || 0;
        });
        
        // Limit discount to subtotal
        discountAmount = Math.min(amount, subtotal);
        if (amount > subtotal) {
            document.getElementById('discountAmount').value = subtotal.toFixed(2);
        }
        
        // Calculate percentage
        discountPercentage = subtotal > 0 ? (discountAmount / subtotal) * 100 : 0;
        
        // Update percentage input
        document.getElementById('discountPercentage').value = discountPercentage.toFixed(2);
        
        // Recalculate bill
        calculateBill();
    }

    // Update discount from percentage
    function updateDiscountFromPercentage() {
        const percentage = parseFloat(document.getElementById('discountPercentage').value) || 0;
        
        // Calculate subtotal
        const priceInputs = document.querySelectorAll('.price-input');
        let subtotal = 0;
        priceInputs.forEach(input => {
            subtotal += parseFloat(input.value) || 0;
        });
        
        // Limit percentage to 100
        discountPercentage = Math.min(percentage, 100);
        if (percentage > 100) {
            document.getElementById('discountPercentage').value = '100';
        }
        
        // Calculate amount
        discountAmount = (subtotal * discountPercentage) / 100;
        
        // Update amount input
        document.getElementById('discountAmount').value = discountAmount.toFixed(2);
        
        // Recalculate bill
        calculateBill();
    }

    // Populate thermal receipt with data
    function populateThermalReceipt(medicines, subtotal, finalTotal) {
        const now = new Date();
        const dateStr = now.toLocaleDateString('en-GB');
        const timeStr = now.toLocaleTimeString('en-US', { hour12: true, hour: '2-digit', minute: '2-digit' });
        
        // Set date, time, patient info
        document.getElementById('receiptDate').textContent = dateStr;
        document.getElementById('receiptTime').textContent = timeStr;
        
        // Truncate patient name if too long (max 20 chars)
        const patientName = currentPatient ? currentPatient.name : 'N/A';
        document.getElementById('receiptPatient').textContent = patientName.length > 20 ? patientName.substring(0, 18) + '..' : patientName;
        document.getElementById('receiptRefNo').textContent = currentPatient ? currentPatient.ref_no : 'N/A';
        
        // Build items list
        let itemsHTML = '';
        medicines.forEach((item, index) => {
            // Truncate medicine name if too long (max 22 chars for 80mm paper)
            let medName = item.medicine_name;
            if (medName.length > 22) {
                medName = medName.substring(0, 20) + '..';
            }
            // Get quantity label from the table
            const qtyLabel = item.qty_label || `${item.days} day(s)`;
            itemsHTML += `
                <div class="item-row" style="color: #000 !important; font-weight: 900 !important;">
                    <div class="item-name" style="color: #000 !important; font-weight: 900 !important;">${index + 1}. ${medName}</div>
                    <div class="item-details" style="color: #000 !important; font-weight: 900 !important;">
                        <span style="color: #000 !important; font-weight: 900 !important;">${qtyLabel}</span>
                        <span style="color: #000 !important; font-weight: 900 !important;">Rs. ${Math.round(item.price)}</span>
                    </div>
                </div>
            `;
        });
        document.getElementById('receiptItems').innerHTML = itemsHTML;
        
        // Set totals
        document.getElementById('receiptSubtotal').textContent = `Rs. ${Math.round(subtotal)}`;
        
        // Show/hide discount
        if (discountAmount > 0) {
            document.getElementById('receiptDiscountLine').style.display = 'flex';
            document.getElementById('receiptDiscountLabel').textContent = `Discount (${discountPercentage.toFixed(1)}%):`;
            document.getElementById('receiptDiscount').textContent = `- Rs. ${Math.round(discountAmount)}`;
        } else {
            document.getElementById('receiptDiscountLine').style.display = 'none';
        }
        
        document.getElementById('receiptGrandTotal').textContent = `Rs. ${Math.round(finalTotal)}`;
    }

    // Process order
    function processOrder(forceSell = false) {
        // In direct sale mode, patient is optional for walk-in customers
        if (!currentPatient && !directSaleMode) {
            Modal.error('Please search and select a patient first!', 'No Patient Selected');
            return;
        }
        
        // For direct sale without patient, create a walk-in patient reference
        if (!currentPatient && directSaleMode) {
            const now = new Date();
            currentPatient = {
                ref_no: 'WALK-IN-' + now.getTime(),
                name: 'Walk-in Customer',
                phone: 'N/A',
                age: 'N/A'
            };
        }
        
        const medicines = [];
        const rows = document.querySelectorAll('#prescriptionRows tr');
        
        rows.forEach(row => {
            const medicineInput = row.querySelector('.medicine-input');
            const daysInput = row.querySelector('.days-input');
            const priceInput = row.querySelector('.price-input');
            const qtyLabel = row.querySelector('.qty-label');
            
            if (medicineInput && priceInput) {
                const medicineName = medicineInput.value.trim();
                const medicineId = medicineInput.getAttribute('data-medicine-id');
                const days = parseInt(daysInput.value) || 0;
                const price = parseFloat(priceInput.value) || 0;
                const qtyText = qtyLabel ? qtyLabel.textContent.trim() : `${days} day(s)`;
                
                if (medicineName && price > 0) {
                    medicines.push({
                        medicine_id: medicineId,
                        medicine_name: medicineName,
                        days: days,
                        price: price,
                        qty_label: qtyText
                    });
                }
            }
        });
        
        if (medicines.length === 0) {
            Modal.warning('Please enter prices for the medicines!', 'No Items to Process');
            return;
        }
        
        const subtotal = medicines.reduce((sum, item) => sum + item.price, 0);
        const finalTotal = subtotal - discountAmount;
        
        // Populate thermal receipt
        populateThermalReceipt(medicines, subtotal, finalTotal);
        
        // Show loading
        Modal.loading('Processing order and generating bill...', 'Please Wait');
        
        // Send order to server
        fetch('/pharmacy/api/process-order/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': '{{ csrf_token }}'
            },
            body: JSON.stringify({
                patient_ref_no: currentPatient.ref_no,
                medicines: medicines,
                total_amount: finalTotal,
                discount_amount: discountAmount,
                discount_percentage: discountPercentage,
                is_direct_sale: directSaleMode,
                force_sell: forceSell  // Allow selling with insufficient stock
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                Modal.close();
                
                Modal.success(
                    `Order processed successfully!<br><br>
                    <strong>Patient:</strong> ${data.patient_name}<br>
                    <strong>Items:</strong> ${data.items_count}<br>
                    <strong>Total:</strong> PKR ${data.total_amount.toFixed(2)}<br><br>
                    <small>Printing receipt...</small>`,
                    'Order Complete',
                    4000
                );
                
                // Show print receipt button
                document.getElementById('printReceiptBtn').style.display = 'block';
                
                // Auto print receipt
                setTimeout(() => {
                    printReceipt();
                }, 1000);
                
                // Clear after some time (but keep print button)
                setTimeout(() => {
                    resetForm();
                }, 8000);
            } else {
                // Check if it's an insufficient stock error
                if (data.insufficient_stock) {
                    Modal.close();
                    setTimeout(() => {
                        // Show confirmation dialog for force sell
                        Modal.show({
                            type: 'warning',
                            title: '⚠️ Insufficient Stock',
                            message: `
                                <div style="text-align: left; line-height: 1.8; color: #000;">
                                    <p style="color: #000; font-weight: 600; font-size: 1rem;"><strong>Medicine:</strong> ${data.medicine_name}</p>
                                    <p style="color: #000; font-weight: 600;"><strong>Available:</strong> ${data.available} ${data.unit}</p>
                                    <p style="color: #000; font-weight: 600;"><strong>Required:</strong> ${data.required} ${data.unit}</p>
                                    <hr style="border-color: rgba(0,0,0,0.2); margin: 15px 0;">
                                    <p style="font-size: 1rem; color: #ff8800; font-weight: 700; background: #fff3cd; padding: 10px; border-radius: 6px; border-left: 4px solid #ff8800;">
                                        <i class="fas fa-info-circle"></i> Stock may exist physically but not entered in system.
                                    </p>
                                    <p style="font-size: 0.95rem; color: #000; font-weight: 500; margin-top: 12px;">
                                        Click <strong style="color: #0066cc;">"Continue Anyway"</strong> to proceed with the sale.<br>
                                        Stock will be recorded as negative and can be adjusted later when you add the actual stock.
                                    </p>
                                </div>
                            `,
                            buttons: [
                                {
                                    text: 'Cancel',
                                    style: 'secondary',
                                    onClick: () => Modal.close()
                                },
                                {
                                    text: '✓ Continue Anyway',
                                    style: 'primary',
                                    onClick: () => {
                                        Modal.close();
                                        // Retry with force_sell = true
                                        setTimeout(() => {
                                            processOrder(true);
                                        }, 400);
                                    }
                                }
                            ],
                            autoDismiss: 0
                        });
                    }, 400);
                } else {
                    // Other errors
                    Modal.close();
                    setTimeout(() => {
                        Modal.error('Failed to process order: ' + (data.error || 'Unknown error'), 'Processing Failed', 7000);
                    }, 400);
                }
            }
        })
        .catch(error => {
            Modal.close();
            console.error('Process error:', error);
            Modal.error('Connection error. Please try again.', 'Network Error', 5000);
        });
    }
    
    // Print thermal receipt
    function printReceipt() {
        // Create a print window with just the receipt
        const receiptContent = document.getElementById('thermalReceipt').outerHTML;
        const printWindow = window.open('', '_blank', 'width=400,height=600');
        
        printWindow.document.write(`
            <!DOCTYPE html>
            <html>
            <head>
                <title>Pharmacy Receipt</title>
                <style>
                    * {
                        margin: 0;
                        padding: 0;
                        box-sizing: border-box;
                    }
                    body {
                        font-family: 'Courier New', monospace;
                        background: white;
                        padding: 10px;
                    }
                    .thermal-receipt {
                        width: 72mm;
                        padding: 5mm;
                        background: white;
                        font-size: 12px;
                        display: block !important;
                    }
                    .header {
                        text-align: center;
                        border-bottom: 1px dashed #000;
                        padding-bottom: 8px;
                        margin-bottom: 8px;
                    }
                    .clinic-name {
                        font-size: 16px;
                        font-weight: bold;
                    }
                    .receipt-title {
                        font-size: 14px;
                        margin-top: 5px;
                        font-weight: bold;
                    }
                    .info-line {
                        display: flex;
                        justify-content: space-between;
                        margin: 3px 0;
                        font-size: 11px;
                    }
                    .section-title {
                        font-weight: bold;
                        margin: 8px 0 5px 0;
                        border-bottom: 1px dashed #000;
                        padding-bottom: 3px;
                    }
                    .item-row {
                        margin: 5px 0;
                        padding-bottom: 5px;
                        border-bottom: 1px dotted #ccc;
                    }
                    .item-name {
                        font-weight: bold;
                        font-size: 11px;
                    }
                    .item-details {
                        display: flex;
                        justify-content: space-between;
                        font-size: 10px;
                        color: #333;
                        margin-top: 2px;
                    }
                    .totals {
                        margin-top: 10px;
                        border-top: 1px dashed #000;
                        padding-top: 8px;
                    }
                    .total-line {
                        display: flex;
                        justify-content: space-between;
                        margin: 3px 0;
                        font-size: 12px;
                    }
                    .grand-total {
                        font-weight: bold;
                        font-size: 14px;
                        border-top: 1px solid #000;
                        padding-top: 5px;
                        margin-top: 5px;
                    }
                    .discount-line {
                        color: #c00;
                    }
                    .footer {
                        margin-top: 15px;
                        text-align: center;
                        border-top: 1px dashed #000;
                        padding-top: 10px;
                        font-size: 11px;
                    }
                    .thank-you {
                        font-weight: bold;
                        font-size: 14px;
                        margin-bottom: 5px;
                    }
                    .print-buttons {
                        margin: 20px 0;
                        text-align: center;
                    }
                    .print-btn {
                        background: #4CAF50;
                        color: white;
                        padding: 12px 30px;
                        border: none;
                        border-radius: 5px;
                        font-size: 16px;
                        cursor: pointer;
                        margin: 5px;
                    }
                    .print-btn:hover {
                        background: #388E3C;
                    }
                    .close-btn {
                        background: #f44336;
                        color: white;
                        padding: 12px 30px;
                        border: none;
                        border-radius: 5px;
                        font-size: 16px;
                        cursor: pointer;
                        margin: 5px;
                    }
                    .close-btn:hover {
                        background: #c62828;
                    }
                    @media print {
                        .print-buttons {
                            display: none !important;
                        }
                        body {
                            padding: 0;
                        }
                        @page {
                            size: 80mm auto;
                            margin: 0;
                        }
                    }
                </style>
            </head>
            <body>
                <div class="print-buttons">
                    <button class="print-btn" onclick="window.print()"><i class="fas fa-print"></i> Print Receipt</button>
                    <button class="close-btn" onclick="window.close()"><i class="fas fa-times"></i> Close</button>
                </div>
                ${receiptContent}
            </body>
            </html>
        `);
        
        printWindow.document.close();
    }

    // Helper function to update patient details with modern layout
    function updatePatientDetails(patient) {
        const html = `
            <div class="patient-info">
                <div class="patient-row">
                    <i class="fas fa-hashtag"></i>
                    <span class="patient-label">Ref No</span>
                    <span class="patient-value">${patient.ref_no || 'N/A'}</span>
                </div>
                <div class="patient-row">
                    <i class="fas fa-user"></i>
                    <span class="patient-label">Name</span>
                    <span class="patient-value">${patient.name || 'N/A'}</span>
                </div>
                <div class="patient-row">
                    <i class="fas fa-phone"></i>
                    <span class="patient-label">Phone</span>
                    <span class="patient-value">${patient.phone || 'N/A'}</span>
                </div>
                <div class="patient-row">
                    <i class="fas fa-birthday-cake"></i>
                    <span class="patient-label">Age</span>
                    <span class="patient-value">${patient.age || 'N/A'}</span>
                </div>
            </div>`;
        document.getElementById('patientContent').innerHTML = html;
    }

    // Helper function to reset patient details
    function resetPatientDetails() {
        document.getElementById('patientContent').innerHTML = `
            <div class="patient-empty">
                <i class="fas fa-user-slash"></i>
                <p>No patient selected</p>
                <small>Search by reference number</small>
            </div>`;
    }

    // Helper function to reset bill content
    function resetBillContent() {
        document.getElementById('billContent').innerHTML = `
            <div class="bill-empty">
                <i class="fas fa-shopping-cart"></i>
                <p>No items added yet</p>
                <small>Add medicines to see bill preview</small>
            </div>`;
    }

    // Reset form
    function resetForm() {
        document.getElementById('refNoInput').value = '';
        document.getElementById('prescriptionRows').innerHTML = '';
        resetPatientDetails();
        resetBillContent();
        document.getElementById('searchStatus').style.display = 'none';
        document.getElementById('printReceiptBtn').style.display = 'none';
        currentPatient = null;
        currentPrescriptions = [];
    }

    // Allow Enter key to search
    document.getElementById('refNoInput').addEventListener('keypress', function(e) {
        if (e.key === 'Enter') {
            searchPrescription();
        }
    });

    // Enter key acts like Tab in prescription table
    document.getElementById('prescriptionRows').addEventListener('keydown', function(e) {
        if (e.key === 'Enter') {
            e.preventDefault();
            
            // Get all focusable elements in the table
            const focusableElements = Array.from(document.querySelectorAll(
                '#prescriptionRows input:not([type="hidden"]), #prescriptionRows select, #prescriptionRows button'
            )).filter(el => !el.disabled && el.offsetParent !== null);
            
            const currentIndex = focusableElements.indexOf(document.activeElement);
            
            if (currentIndex > -1 && currentIndex < focusableElements.length - 1) {
                // Move to next element
                focusableElements[currentIndex + 1].focus();
            } else if (currentIndex === focusableElements.length - 1) {
                // If at last element, add new row and focus on medicine input
                addMedicineRow();
                setTimeout(() => {
                    const newMedicineInput = document.querySelector('#prescriptionRows tr:last-child .medicine-input');
                    if (newMedicineInput) newMedicineInput.focus();
                }, 50);
            }
        }
    });

    // ============ SETTINGS FUNCTIONS ============
    
    function openSettings() {
        // Close side menu first
        sideMenu.classList.remove("active");
        overlay.classList.remove("active");
        
        // Open settings modal
        document.getElementById('settingsModal').classList.add('active');
        
        // Load database info
        loadDatabaseInfo();
    }
    
    function closeSettings() {
        document.getElementById('settingsModal').classList.remove('active');
    }
    
    // Close settings when clicking outside
    document.getElementById('settingsModal').addEventListener('click', function(e) {
        if (e.target === this) {
            closeSettings();
        }
    });
    
    function loadDatabaseInfo() {
        fetch('/pharmacy/api/database-info/')
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    document.getElementById('dbPath').textContent = data.path;
                    document.getElementById('dbSize').textContent = data.size;
                    document.getElementById('dbModified').textContent = data.last_modified;
                } else {
                    document.getElementById('dbPath').textContent = 'Error loading';
                    document.getElementById('dbSize').textContent = '-';
                    document.getElementById('dbModified').textContent = '-';
                }
            })
            .catch(error => {
                console.error('Error loading DB info:', error);
                document.getElementById('dbPath').textContent = 'Error';
            });
    }
    
    function downloadBackup() {
        Modal.loading('Preparing database backup...', 'Please Wait');
        
        // Create hidden link and trigger download
        const link = document.createElement('a');
        link.href = '/pharmacy/api/download-database/';
        link.download = 'clinic_backup.sqlite3';
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
        
        setTimeout(() => {
            Modal.close();
            Modal.success('Database backup download started!<br><br>Save this file in a safe location.', 'Backup Ready', 3000);
        }, 1000);
    }
    
    function uploadBackup() {
        const fileInput = document.getElementById('dbFileInput');
        const file = fileInput.files[0];
        
        if (!file) {
            return;
        }
        
        // Confirm before uploading
        if (!confirm('WARNING: This will replace ALL current data with the backup!\n\nAre you absolutely sure you want to continue?')) {
            fileInput.value = '';
            return;
        }
        
        Modal.loading('Uploading and restoring database...', 'Please Wait');
        
        const formData = new FormData();
        formData.append('database', file);
        
        fetch('/pharmacy/api/upload-database/', {
            method: 'POST',
            body: formData
        })
        .then(response => response.json())
        .then(data => {
            Modal.close();
            fileInput.value = '';
            
            if (data.success) {
                Modal.success(
                    data.message + '<br><br><strong>The page will reload in 5 seconds...</strong>',
                    'Database Restored',
                    5000
                );
                
                // Reload page after 5 seconds
                setTimeout(() => {
                    window.location.reload();
                }, 5000);
            } else {
                Modal.error('Failed to restore database: ' + data.error, 'Restore Failed');
            }
        })
        .catch(error => {
            Modal.close();
            fileInput.value = '';
            console.error('Upload error:', error);
            Modal.error('Connection error. Please try again.', 'Upload Failed');
        });
    }
    
    // ==================== GOOGLE DRIVE BACKUP ====================
    
    // Check Google Drive status when settings open
    function checkGDriveStatus() {
        fetch('/pharmacy/api/gdrive/status/')
            .then(response => response.json())
            .then(data => {
                const statusText = document.getElementById('gdriveStatusText');
                const notConnected = document.getElementById('gdriveNotConnected');
                const connected = document.getElementById('gdriveConnected');
                const statusDiv = document.getElementById('gdriveStatus');
                
                if (data.authenticated) {
                    statusText.innerHTML = '<i class="fas fa-check-circle"></i> Connected to Google Drive';
                    statusDiv.style.background = 'rgba(76, 175, 80, 0.3)';
                    notConnected.style.display = 'none';
                    connected.style.display = 'block';
                } else {
                    statusText.innerHTML = '<i class="fas fa-times-circle"></i> Not connected';
                    statusDiv.style.background = 'rgba(244, 67, 54, 0.3)';
                    notConnected.style.display = 'block';
                    connected.style.display = 'none';
                }
            })
            .catch(error => {
                console.error('GDrive status error:', error);
                document.getElementById('gdriveStatusText').innerHTML = '<i class="fas fa-exclamation-triangle"></i> Could not check status';
            });
    }
    
    // Show Google Drive setup modal
    function showGDriveSetup() {
        document.getElementById('gdriveSetupModal').classList.add('active');
        document.getElementById('gdriveSetupStep1').style.display = 'block';
        document.getElementById('gdriveSetupStep2').style.display = 'none';
    }
    
    function closeGDriveSetup() {
        document.getElementById('gdriveSetupModal').classList.remove('active');
    }
    
    // Save Google Drive credentials
    function saveGDriveCredentials() {
        const clientId = document.getElementById('gdriveClientId').value.trim();
        const clientSecret = document.getElementById('gdriveClientSecret').value.trim();
        
        if (!clientId || !clientSecret) {
            alert('Please enter both Client ID and Client Secret');
            return;
        }
        
        fetch('/pharmacy/api/gdrive/setup/', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({
                client_id: clientId,
                client_secret: clientSecret
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                document.getElementById('gdriveSetupStep1').style.display = 'none';
                document.getElementById('gdriveSetupStep2').style.display = 'block';
            } else {
                alert('Error: ' + data.error);
            }
        })
        .catch(error => {
            alert('Connection error: ' + error);
        });
    }
    
    // Start Google Drive authentication
    function startGDriveAuth() {
        fetch('/pharmacy/api/gdrive/auth-url/')
            .then(response => response.json())
            .then(data => {
                if (data.auth_url) {
                    // Open auth URL in new window
                    window.open(data.auth_url, '_blank', 'width=600,height=700');
                    document.getElementById('authCodeSection').style.display = 'block';
                } else if (data.needs_setup) {
                    alert('Please complete step 1 first');
                    document.getElementById('gdriveSetupStep1').style.display = 'block';
                    document.getElementById('gdriveSetupStep2').style.display = 'none';
                } else {
                    alert('Error: ' + data.error);
                }
            })
            .catch(error => {
                alert('Connection error: ' + error);
            });
    }
    
    // Complete Google Drive authentication
    function completeGDriveAuth() {
        const code = document.getElementById('gdriveAuthCode').value.trim();
        
        if (!code) {
            alert('Please paste the authorization code');
            return;
        }
        
        fetch('/pharmacy/api/gdrive/auth-complete/', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({ code: code })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                closeGDriveSetup();
                checkGDriveStatus();
                Modal.success('Google Drive connected successfully!<br><br>You can now backup to cloud.', 'Connected!', 3000);
            } else {
                alert('Error: ' + data.error);
            }
        })
        .catch(error => {
            alert('Connection error: ' + error);
        });
    }
    
    // Backup to Google Drive
    function backupToGDrive() {
        Modal.loading('Uploading backup to Google Drive...', 'Cloud Backup');
        
        fetch('/pharmacy/api/gdrive/backup/', {
            method: 'POST'
        })
        .then(response => response.json())
        .then(data => {
            Modal.close();
            
            if (data.success) {
                Modal.success(
                    `<strong>${data.message}</strong><br><br>` +
                    `File: ${data.file_name}<br>` +
                    `<a href="${data.web_link}" target="_blank" style="color: #4285f4;">View in Google Drive</a>`,
                    '☁️ Cloud Backup Complete',
                    5000
                );
            } else if (data.needs_auth) {
                Modal.error('Please connect to Google Drive first.<br><br>Local backup was saved.', 'Not Connected');
            } else {
                Modal.error('Backup failed: ' + data.error + '<br><br>Local backup: ' + (data.local_backup || 'saved'), 'Backup Error');
            }
        })
        .catch(error => {
            Modal.close();
            Modal.error('Connection error: ' + error, 'Backup Failed');
        });
    }
    
    // Disconnect Google Drive
    function disconnectGDrive() {
        if (!confirm('Are you sure you want to disconnect Google Drive?')) {
            return;
        }
        
        fetch('/pharmacy/api/gdrive/disconnect/', {
            method: 'POST'
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                checkGDriveStatus();
                Modal.success('Google Drive disconnected.', 'Disconnected', 2000);
            } else {
                alert('Error: ' + data.error);
            }
        })
        .catch(error => {
            alert('Error: ' + error);
        });
    }
    
    // Close app with backup prompt
    function closeAppWithBackup() {
        // Check if connected to Google Drive
        fetch('/pharmacy/api/gdrive/status/')
            .then(response => response.json())
            .then(data => {
                if (data.authenticated) {
                    // Ask to backup to cloud
                    if (confirm('آج کا کام ختم ہو گیا؟\n\nکیا آپ Google Drive پر backup لینا چاہتے ہیں؟\n(Yes = Cloud Backup, No = Local Only)')) {
                        // Backup to cloud then close
                        Modal.loading('Creating cloud backup before closing...', 'Backup & Close');
                        
                        fetch('/pharmacy/api/gdrive/backup/', { method: 'POST' })
                            .then(response => response.json())
                            .then(backupData => {
                                Modal.close();
                                
                                if (backupData.success) {
                                    Modal.success(
                                        '☁️ Cloud backup saved successfully!<br><br>' +
                                        'Application will close in 3 seconds...',
                                        'Backup Complete',
                                        3000
                                    );
                                    setTimeout(() => {
                                        closeApplication();
                                    }, 3000);
                                } else {
                                    alert('Cloud backup failed, but local backup saved.\n\nClosing app...');
                                    closeApplication();
                                }
                            })
                            .catch(() => {
                                Modal.close();
                                alert('Backup error. Closing app...');
                                closeApplication();
                            });
                    } else {
                        // Just close without cloud backup
                        createLocalBackupAndClose();
                    }
                } else {
                    // Not connected to cloud, just local backup
                    createLocalBackupAndClose();
                }
            })
            .catch(() => {
                createLocalBackupAndClose();
            });
    }
    
    function createLocalBackupAndClose() {
        Modal.loading('Creating local backup...', 'Closing');
        
        // Trigger local backup download
        const link = document.createElement('a');
        link.href = '/pharmacy/api/download-database/';
        link.download = 'clinic_backup_' + new Date().toISOString().split('T')[0] + '.sqlite3';
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
        
        setTimeout(() => {
            Modal.close();
            closeApplication();
        }, 1500);
    }
    
    function closeApplication() {
        // Try to close Electron app
        if (window.electronAPI && window.electronAPI.closeApp) {
            window.electronAPI.closeApp();
        } else {
            // Fallback - just show message
            Modal.success('You can now close this window.<br><br>Thank you for using Clinic Management System!', 'Goodbye!', 5000);
        }
    }
    
    // Check daily backup status when page loads
    document.addEventListener('DOMContentLoaded', function() {
        // Check if backup needed today
        fetch('/pharmacy/api/gdrive/check-daily/')
            .then(response => response.json())
            .then(data => {
                if (data.needs_backup) {
                    // Show subtle reminder after 5 seconds
                    setTimeout(() => {
                        const reminder = document.createElement('div');
                        reminder.innerHTML = `
                            <div style="position: fixed; bottom: 20px; right: 20px; background: linear-gradient(135deg, #4285f4 0%, #0f9d58 100%); 
                                        color: white; padding: 15px 20px; border-radius: 12px; box-shadow: 0 4px 15px rgba(0,0,0,0.3); 
                                        z-index: 9999; cursor: pointer; max-width: 300px;" onclick="this.remove(); openSettings();">
                                <strong>💡 Daily Backup Reminder</strong><br>
                                <small>آج کا backup ابھی تک نہیں لیا۔ Settings میں جا کر backup لیں۔</small>
                            </div>
                        `;
                        document.body.appendChild(reminder);
                        
                        // Auto-hide after 10 seconds
                        setTimeout(() => {
                            if (reminder.parentElement) reminder.remove();
                        }, 10000);
                    }, 5000);
                }
            })
            .catch(() => {});
    });
    
    // Override openSettings to also check GDrive status
    const originalOpenSettings = openSettings;
    openSettings = function() {
        originalOpenSettings();
        checkGDriveStatus();
    };
    
    // ========== PHARMACY QUEUE SYSTEM ==========
    let pharmacyQueuePanelOpen = false;
    
    function togglePharmacyQueue() {
        const panel = document.getElementById('pharmacyQueuePanel');
        pharmacyQueuePanelOpen = !pharmacyQueuePanelOpen;
        
        if (pharmacyQueuePanelOpen) {
            panel.classList.add('active');
            loadPharmacyQueue();
        } else {
            panel.classList.remove('active');
        }
    }
    
    function loadPharmacyQueue() {
        fetch('/pharmacy/api/queue/')
            .then(response => response.json())
            .then(data => {
                updatePharmacyQueueUI(data.queue || []);
            })
            .catch(error => {
                console.error('Error loading pharmacy queue:', error);
            });
    }
    
    function updatePharmacyQueueUI(queueItems) {
        const listContainer = document.getElementById('pharmacyQueueList');
        const waitingCount = queueItems.filter(p => p.status === 'waiting').length;
        const dispensingCount = queueItems.filter(p => p.status === 'dispensing').length;
        
        // Update stats
        document.getElementById('waitingCount').textContent = waitingCount;
        document.getElementById('dispensingCount').textContent = dispensingCount;
        document.getElementById('pharmacyQueueCount').textContent = queueItems.length;
        
        if (queueItems.length === 0) {
            listContainer.innerHTML = `
                <div class="pharmacy-queue-empty">
                    <i class="fas fa-inbox"></i>
                    <p>No prescriptions in queue</p>
                    <small style="color: rgba(255,255,255,0.4);">Patients will appear here after doctor prints prescription</small>
                </div>
            `;
            return;
        }
        
        let html = '';
        queueItems.forEach(patient => {
            const statusClass = patient.status === 'dispensing' ? 'dispensing' : '';
            const badge = patient.status === 'dispensing' ? '<span class="pharmacy-queue-badge dispensing">Dispensing</span>' : '';
            const timeAgo = formatTimeAgo(patient.queued_at);
            
            html += `
                <div class="pharmacy-queue-item ${statusClass}" onclick="selectPharmacyPatient(${patient.id}, '${patient.reference_number}')" data-patient-id="${patient.id}">
                    <div style="display: flex; align-items: center;">
                        <span class="pharmacy-queue-number">${patient.queue_number}</span>
                        <div class="pharmacy-queue-item-content">
                            <div class="pharmacy-queue-patient-name">${patient.name}</div>
                            <div class="pharmacy-queue-patient-details">
                                <span class="pharmacy-queue-patient-ref">${patient.reference_number}</span>
                                <span>${patient.age || 'N/A'}</span>
                            </div>
                            <div class="pharmacy-queue-time">
                                <i class="far fa-clock"></i> ${timeAgo}
                            </div>
                        </div>
                        ${badge}
                    </div>
                </div>
            `;
        });
        
        listContainer.innerHTML = html;
    }
    
    function selectPharmacyPatient(patientId, referenceNumber) {
        // Mark as dispensing
        fetch(`/pharmacy/api/queue/select/${patientId}/`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                // Close queue panel
                togglePharmacyQueue();
                
                // Fill the search input with reference number
                const searchInput = document.getElementById('refNoInput');
                if (searchInput) {
                    searchInput.value = referenceNumber;
                    // Trigger the search automatically
                    searchPrescription();
                }
                
                // Refresh queue to update UI
                setTimeout(loadPharmacyQueue, 500);
            }
        })
        .catch(error => {
            console.error('Error selecting patient:', error);
        });
    }
    
    function formatTimeAgo(timestamp) {
        if (!timestamp) return '';
        const now = new Date();
        const then = new Date(timestamp);
        const diffMs = now - then;
        const diffMins = Math.floor(diffMs / 60000);
        
        if (diffMins < 1) return 'Just now';
        if (diffMins < 60) return `${diffMins} min ago`;
        
        const diffHours = Math.floor(diffMins / 60);
        if (diffHours < 24) return `${diffHours} hr ago`;
        
        return then.toLocaleDateString();
    }
    
    // ============== NETWORK/SERVER FUNCTIONS ==============
    
    function loadNetworkStatus() {
        fetch('/pharmacy/api/network/status/')
            .then(response => response.json())
            .then(data => {
                const statusIcon = document.getElementById('networkStatusIcon');
                const statusText = document.getElementById('networkStatusText');
                const ipInfo = document.getElementById('networkIPInfo');
                const btnServer = document.getElementById('btnSetServer');
                const connectSection = document.getElementById('connectSection');
                const btnDisconnect = document.getElementById('btnDisconnect');
                
                if (data.success) {
                    // Update IP info
                    ipInfo.innerHTML = `<i class="fas fa-laptop"></i> This PC: ${data.local_ip}`;
                    
                    if (data.mode === 'server') {
                        statusIcon.innerHTML = '<i class="fas fa-circle"></i>';
                        statusIcon.style.color = '#28a745';
                        statusText.innerHTML = `<strong style="color:#28a745;">SERVER MODE</strong><br><small>IP: ${data.local_ip}:8000</small>`;
                        btnServer.style.display = 'none';
                        connectSection.style.display = 'none';
                        btnDisconnect.style.display = 'block';
                        btnDisconnect.innerHTML = '<i class="fas fa-stop-circle"></i> Stop Server';
                    } else if (data.mode === 'client' && data.is_connected) {
                        statusIcon.innerHTML = '<i class="fas fa-circle"></i>';
                        statusIcon.style.color = '#28a745';
                        statusText.innerHTML = `<strong style="color:#28a745;">CONNECTED</strong><br><small>Server: ${data.server_ip}</small>`;
                        btnServer.style.display = 'none';
                        connectSection.style.display = 'none';
                        btnDisconnect.style.display = 'block';
                        btnDisconnect.innerHTML = '<i class="fas fa-unlink"></i> Disconnect';
                    } else if (data.mode === 'client' && !data.is_connected) {
                        statusIcon.innerHTML = '<i class="fas fa-circle"></i>';
                        statusIcon.style.color = '#dc3545';
                        statusText.innerHTML = `<strong style="color:#dc3545;">DISCONNECTED</strong><br><small>Server unreachable</small>`;
                        btnServer.style.display = 'block';
                        connectSection.style.display = 'block';
                        btnDisconnect.style.display = 'none';
                    } else {
                        // Standalone mode
                        statusIcon.innerHTML = '<i class="fas fa-circle"></i>';
                        statusIcon.style.color = '#ffc107';
                        statusText.innerHTML = `<strong style="color:#ffc107;">STANDALONE</strong><br><small>Local Database</small>`;
                        btnServer.style.display = 'block';
                        connectSection.style.display = 'block';
                        btnDisconnect.style.display = 'none';
                    }
                }
            })
            .catch(error => {
                console.error('Error loading network status:', error);
            });
    }
    
    function setAsServer() {
        if (!confirm('Start this PC as the main server?\n\nOther PCs will be able to connect to this database.')) {
            return;
        }
        
        fetch('/pharmacy/api/network/set-server/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCSRFToken()
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                alert(`✅ Server started!\n\nOther PCs can connect using:\nIP: ${data.server_ip}\nPort: ${data.server_port}`);
                loadNetworkStatus();
            } else {
                alert('❌ Error: ' + data.error);
            }
        })
        .catch(error => {
            alert('❌ Error starting server: ' + error);
        });
    }
    
    function connectToServer() {
        const serverIP = document.getElementById('serverIPInput').value.trim();
        
        if (!serverIP) {
            alert('Please enter the server IP address');
            return;
        }
        
        fetch('/pharmacy/api/network/connect/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCSRFToken()
            },
            body: JSON.stringify({
                server_ip: serverIP,
                server_port: 8000
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                alert(`✅ Connected to server!\n\nRedirecting to: ${data.redirect_url}`);
                // Redirect to the server
                window.location.href = data.redirect_url;
            } else {
                alert('❌ Error: ' + data.error);
            }
        })
        .catch(error => {
            alert('❌ Error connecting: ' + error);
        });
    }
    
    function disconnectFromServer() {
        if (!confirm('Disconnect and use local database?')) {
            return;
        }
        
        fetch('/pharmacy/api/network/disconnect/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCSRFToken()
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                alert('✅ Disconnected. Using local database now.');
                loadNetworkStatus();
            } else {
                alert('❌ Error: ' + data.error);
            }
        })
        .catch(error => {
            alert('❌ Error disconnecting: ' + error);
        });
    }
    
    // ============== MEDICINE RETURN SYSTEM ==============
    
    let returnItems = [];
    let returnSearchTimeout = null;
    
    function openReturnModal() {
        document.getElementById('returnModal').classList.add('active');
        // Reset form
        document.getElementById('returnCustomerName').value = '';
        document.getElementById('returnCustomerPhone').value = '';
        document.getElementById('returnMedicineSearch').value = '';
        document.getElementById('returnReason').value = 'other';
        document.getElementById('returnReasonDetail').value = '';
        document.getElementById('totalRefundAmount').textContent = 'Rs. 0.00';
        document.getElementById('medicineSearchResults').style.display = 'none';
        returnItems = [];
        updateReturnList();
    }
    
    function closeReturnModal() {
        document.getElementById('returnModal').classList.remove('active');
    }
    
    // Close return modal when clicking outside
    document.getElementById('returnModal').addEventListener('click', function(e) {
        if (e.target === this) {
            closeReturnModal();
        }
    });
    
    function searchMedicineForReturn() {
        const query = document.getElementById('returnMedicineSearch').value.trim();
        
        if (returnSearchTimeout) {
            clearTimeout(returnSearchTimeout);
        }
        
        if (query.length < 2) {
            document.getElementById('medicineSearchResults').style.display = 'none';
            return;
        }
        
        returnSearchTimeout = setTimeout(() => {
            fetch(`/pharmacy/api/return/search-medicine/?q=${encodeURIComponent(query)}`)
                .then(response => response.json())
                .then(data => {
                    if (data.success && data.medicines.length > 0) {
                        let html = '';
                        data.medicines.forEach(med => {
                            html += `
                                <div class="medicine-search-item" onclick="addReturnItem('${med.id}', '${med.name.replace(/'/g, "\\'")}', ${med.unit_price}, ${med.purchase_price}, '${med.medicine_form}', '${med.unit_label}')">
                                    <div><strong>${med.name}</strong></div>
                                    <div style="font-size: 0.85rem; color: #aaa;">
                                        ${med.medicine_form} | Rs. ${med.unit_price.toFixed(2)}/${med.unit_label} | Stock: ${med.stock}
                                    </div>
                                </div>
                            `;
                        });
                        document.getElementById('medicineSearchResults').innerHTML = html;
                        document.getElementById('medicineSearchResults').style.display = 'block';
                    } else {
                        document.getElementById('medicineSearchResults').style.display = 'none';
                    }
                })
                .catch(error => {
                    console.error('Error searching medicine:', error);
                });
        }, 300);
    }
    
    function addReturnItem(id, name, salePrice, purchasePrice, form, label) {
        // Check if already added
        const existing = returnItems.find(item => item.medicine_id === id);
        if (existing) {
            existing.quantity++;
        } else {
            returnItems.push({
                medicine_id: id,
                medicine_name: name,
                sale_price: salePrice,
                purchase_price: purchasePrice,
                medicine_form: form,
                unit_label: label,
                quantity: 1
            });
        }
        
        document.getElementById('returnMedicineSearch').value = '';
        document.getElementById('medicineSearchResults').style.display = 'none';
        updateReturnList();
    }
    
    function updateReturnList() {
        if (returnItems.length === 0) {
            document.getElementById('returnItemsList').innerHTML = `
                <div class="no-items-msg">
                    <i class="fas fa-info-circle"></i> Search and add medicines to return
                </div>
            `;
            document.getElementById('totalRefundAmount').textContent = 'Rs. 0.00';
            return;
        }
        
        let html = '';
        let totalRefund = 0;
        
        returnItems.forEach((item, index) => {
            const itemRefund = item.sale_price * item.quantity;
            totalRefund += itemRefund;
            
            html += `
                <div class="return-item">
                    <div class="return-item-info">
                        <div class="return-item-name">${item.medicine_name}</div>
                        <div class="return-item-details">${item.medicine_form} | Rs. ${item.sale_price.toFixed(2)}/${item.unit_label}</div>
                    </div>
                    <div class="return-item-qty">
                        <input type="number" value="${item.quantity}" min="1" 
                               onchange="updateReturnQty(${index}, this.value)">
                    </div>
                    <div class="return-item-price">Rs. ${itemRefund.toFixed(2)}</div>
                    <button class="remove-return-item" onclick="removeReturnItem(${index})">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
            `;
        });
        
        document.getElementById('returnItemsList').innerHTML = html;
        document.getElementById('totalRefundAmount').textContent = 'Rs. ' + totalRefund.toFixed(2);
    }
    
    function updateReturnQty(index, qty) {
        returnItems[index].quantity = parseInt(qty) || 1;
        updateReturnList();
    }
    
    function removeReturnItem(index) {
        returnItems.splice(index, 1);
        updateReturnList();
    }
    
    function processReturn() {
        if (returnItems.length === 0) {
            Modal.warning('Please add at least one medicine to return.', 'No Items');
            return;
        }
        
        const customerName = document.getElementById('returnCustomerName').value.trim() || 'Walk-in Customer';
        const customerPhone = document.getElementById('returnCustomerPhone').value.trim();
        const returnReason = document.getElementById('returnReason').value;
        const returnReasonDetail = document.getElementById('returnReasonDetail').value.trim();
        
        // Calculate totals
        const totalRefund = returnItems.reduce((sum, item) => sum + (item.sale_price * item.quantity), 0);
        
        // Confirm - signature: confirm(message, onConfirm, onCancel, title)
        Modal.confirm(
            `<div style="text-align: left;">
                <p><strong>Customer:</strong> ${customerName}</p>
                <p><strong>Total Refund:</strong> Rs. ${totalRefund.toFixed(2)}</p>
                <p><strong>Items:</strong> ${returnItems.length}</p>
                <p><strong>Reason:</strong> ${document.getElementById('returnReason').options[document.getElementById('returnReason').selectedIndex].text}</p>
            </div>
            <p style="margin-top: 15px; color: #4CAF50;"><i class="fas fa-check"></i> Stock will be restored to inventory</p>
            <p style="color: #ff9800;"><i class="fas fa-chart-line"></i> Profit/Loss will be adjusted</p>
            <p style="margin-top: 15px;">Proceed with return?</p>`,
            () => {
                Modal.loading('Processing return...', 'Please Wait');
                
                const itemsData = returnItems.map(item => ({
                    medicine_id: item.medicine_id,
                    medicine_name: item.medicine_name,
                    quantity: item.quantity,
                    sale_price: item.sale_price,
                    purchase_price: item.purchase_price,
                    medicine_form: item.medicine_form
                }));
                
                fetch('/pharmacy/api/return/process/', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': getCSRFToken()
                    },
                    body: JSON.stringify({
                        customer_name: customerName,
                        customer_phone: customerPhone,
                        return_reason: returnReason,
                        return_reason_detail: returnReasonDetail,
                        items: itemsData
                    })
                })
                .then(response => response.json())
                .then(data => {
                    Modal.close();
                    
                    if (data.success) {
                        let resultHtml = `
                            <div style="text-align: left;">
                                <p><strong>Return #:</strong> ${data.return_number}</p>
                                <p><strong>Total Refund:</strong> Rs. ${data.total_refund.toFixed(2)}</p>
                                <p><strong>Date:</strong> ${data.return_date}</p>
                                <hr style="margin: 10px 0; border-color: rgba(255,255,255,0.2);">
                                <p><strong>Items Returned:</strong></p>
                                <ul style="margin: 5px 0; padding-left: 20px; font-size: 0.9rem;">
                        `;
                        
                        data.returned_items.forEach(item => {
                            resultHtml += `<li>${item.medicine} x ${item.quantity} = Rs. ${item.refund.toFixed(2)} ✓</li>`;
                        });
                        
                        resultHtml += `</ul>
                            <p style="color: #4CAF50; margin-top: 10px;"><i class="fas fa-boxes"></i> Stock restored to inventory</p>
                            <p style="color: #ff9800;"><i class="fas fa-chart-line"></i> Reports adjusted</p>
                        </div>`;
                        
                        Modal.success(resultHtml, 'Return Processed', 5000);
                        closeReturnModal();
                    } else {
                        Modal.error(data.error || 'Failed to process return', 'Return Failed');
                    }
                })
                .catch(error => {
                    Modal.close();
                    Modal.error('Error: ' + error, 'Error');
                });
            },
            null,
            'Confirm Return'
        );
    }
    
    function getCSRFToken() {
        const cookieValue = document.cookie
            .split('; ')
            .find(row => row.startsWith('csrftoken='));
        return cookieValue ? cookieValue.split('=')[1] : '';
    }
    
    // Load pharmacy queue on page load and refresh every 30 seconds
    document.addEventListener('DOMContentLoaded', function() {
        loadPharmacyQueue();
        setInterval(loadPharmacyQueue, 30000);
        
        // Load network status
        loadNetworkStatus();
        setInterval(loadNetworkStatus, 10000); // Refresh every 10 seconds
    });
</script>
{% endblock js %}