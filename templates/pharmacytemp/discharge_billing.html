{% extends "base.html" %}
{% load static %}

{% block title %}Discharge Bill{% endblock title %}

{% block style %}
<style>
  * {
    margin: 0;
    padding: 0;
    box-sizing: border-box;
  }

  body {
    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    background: linear-gradient(135deg, #1a472a 0%, #2d5016 50%, #4a7c2d 100%);
    min-height: 100vh;
    padding: 20px;
    color: white;
  }

  .header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 20px 30px;
    background: rgba(255, 255, 255, 0.1);
    backdrop-filter: blur(10px);
    border-radius: 15px;
    margin-bottom: 30px;
    box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
  }

  .header h1 {
    font-size: 1.8rem;
    font-weight: 700;
  }

  .back-btn {
    background: rgba(255, 255, 255, 0.2);
    color: white;
    padding: 10px 20px;
    border-radius: 10px;
    text-decoration: none;
    transition: all 0.3s ease;
    border: 1px solid rgba(255, 255, 255, 0.3);
  }

  .back-btn:hover {
    background: rgba(255, 255, 255, 0.3);
  }

  .container {
    max-width: 900px;
    margin: 0 auto;
  }

  .bill-container {
    background: white;
    color: #333;
    border-radius: 12px;
    padding: 40px;
    box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
  }

  .bill-header {
    text-align: center;
    padding-bottom: 30px;
    border-bottom: 3px solid #0066cc;
    margin-bottom: 30px;
  }

  .bill-header h1 {
    color: #0066cc;
    font-size: 2rem;
    margin-bottom: 10px;
  }

  .bill-header p {
    color: #666;
    font-size: 1.1rem;
  }

  .patient-info {
    display: grid;
    grid-template-columns: repeat(2, 1fr);
    gap: 20px;
    margin-bottom: 30px;
    padding: 20px;
    background: #f8f9fa;
    border-radius: 8px;
  }

  .info-item {
    display: flex;
    flex-direction: column;
  }

  .info-label {
    font-size: 0.85rem;
    color: #666;
    margin-bottom: 5px;
  }

  .info-value {
    font-size: 1.05rem;
    font-weight: 600;
    color: #333;
  }

  .section-title {
    font-size: 1.3rem;
    color: #0066cc;
    margin: 30px 0 15px;
    padding-bottom: 10px;
    border-bottom: 2px solid #e0e0e0;
  }

  table {
    width: 100%;
    border-collapse: collapse;
    margin-bottom: 30px;
  }

  thead th {
    background: #0066cc;
    color: white;
    padding: 12px;
    text-align: left;
    font-weight: 600;
  }

  tbody td {
    padding: 10px 12px;
    border-bottom: 1px solid #e0e0e0;
  }

  tbody tr:hover {
    background: #f8f9fa;
  }

  .total-row {
    background: #e3f2fd;
    font-weight: 700;
  }

  .grand-total-row {
    background: #0066cc;
    color: white;
    font-size: 1.2rem;
    font-weight: 700;
  }

  .action-buttons {
    display: flex;
    gap: 15px;
    margin-top: 30px;
  }

  .btn {
    flex: 1;
    padding: 15px;
    border: none;
    border-radius: 8px;
    font-size: 1rem;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.3s ease;
    text-decoration: none;
    text-align: center;
    display: inline-block;
  }

  .btn-print {
    background: #28a745;
    color: white;
  }

  .btn-print:hover {
    background: #218838;
  }

  .btn-back {
    background: #6c757d;
    color: white;
  }

  .btn-back:hover {
    background: #5a6268;
  }

  /* Thermal Printer Receipt Styles (80mm) */
  .thermal-receipt {
    display: none;
  }

  @media print {
    /* Set page size for thermal printer */
    @page {
      size: 80mm auto;
      margin: 0;
    }
    
    body {
      margin: 0;
      padding: 0;
    }
    
    body * {
      display: none !important;
    }
    
    .thermal-receipt {
      display: block !important;
      position: absolute;
      left: 0;
      top: 0;
      width: 80mm;
      padding: 5mm;
      margin: 0;
      font-family: 'Courier New', monospace;
      font-size: 11pt;
      line-height: 1.4;
      color: #000;
      background: #fff;
      -webkit-print-color-adjust: exact !important;
      print-color-adjust: exact !important;
    }
    
    .thermal-receipt * {
      display: block !important;
      box-shadow: none !important;
      text-shadow: none !important;
      background: transparent !important;
      border-radius: 0 !important;
      color: #000 !important;
      font-weight: bold !important;
      -webkit-print-color-adjust: exact !important;
      print-color-adjust: exact !important;
    }
    
    .thermal-receipt .info-line,
    .thermal-receipt .item-details,
    .thermal-receipt .total-line {
      display: flex !important;
    }
    
    .thermal-receipt .header {
      text-align: center;
      border-bottom: 2px solid #000;
      padding-bottom: 3mm;
      margin-bottom: 3mm;
    }
    
    .thermal-receipt .clinic-name {
      font-size: 14pt;
      font-weight: 900 !important;
      margin-bottom: 1mm;
      color: #000 !important;
    }
    
    .thermal-receipt .receipt-title {
      font-size: 12pt;
      font-weight: 900 !important;
      margin-top: 2mm;
      color: #000 !important;
    }
    
    .thermal-receipt .info-line {
      justify-content: space-between;
      margin: 0.5mm 0;
      font-size: 10pt;
      color: #000 !important;
      font-weight: bold !important;
    }
    
    .thermal-receipt .section-title {
      font-weight: 900 !important;
      border-bottom: 2px solid #000;
      padding: 1mm 0;
      margin: 2mm 0 1mm 0;
      font-size: 11pt;
      color: #000 !important;
      text-align: left;
    }
    
    .thermal-receipt .item-row {
      margin: 1mm 0;
      font-size: 10pt;
      font-weight: bold !important;
      color: #000 !important;
    }
    
    .thermal-receipt .item-name {
      font-weight: bold !important;
      color: #000 !important;
    }
    
    .thermal-receipt .item-details {
      justify-content: space-between;
      padding-left: 2mm;
      font-size: 10pt;
      font-weight: bold !important;
      color: #000 !important;
    }
    
    .thermal-receipt .totals {
      border-top: 2px solid #000;
      margin-top: 2mm;
      padding-top: 1mm;
    }
    
    .thermal-receipt .total-line {
      justify-content: space-between;
      margin: 0.5mm 0;
      font-size: 11pt;
      font-weight: bold !important;
      color: #000 !important;
    }
    
    .thermal-receipt .discount-line {
      color: #000 !important;
      font-size: 10pt;
      font-weight: bold !important;
    }
    
    .thermal-receipt .grand-total {
      font-size: 13pt;
      font-weight: 900 !important;
      border-top: 2px solid #000;
      padding-top: 1mm;
      margin-top: 1mm;
      color: #000 !important;
    }
    
    .thermal-receipt .footer {
      text-align: center;
      border-top: 2px solid #000;
      margin-top: 3mm;
      padding-top: 2mm;
      font-size: 10pt;
      font-weight: bold !important;
      color: #000 !important;
    }
    
    .thermal-receipt .thank-you {
      font-weight: 900 !important;
      margin: 2mm 0;
      font-size: 12pt;
      color: #000 !important;
    }
  }
</style>
{% endblock style %}

{% block content %}
<div class="container">
  <div class="header">
    <h1>ðŸ“„ Discharge Bill</h1>
    <a href="{% url 'admitted_patients_pharmacy' %}" class="back-btn"><i class="fas fa-arrow-left"></i> Back to Pharmacy</a>
  </div>

  <div class="bill-container">
    <div class="bill-header">
      <h1><i class="fas fa-hospital"></i> DISCHARGE BILL</h1>
      <p>Clinic Management System</p>
    </div>

    <div class="patient-info">
      <div class="info-item">
        <span class="info-label">Patient Name:</span>
        <span class="info-value">{{ admission.opd_patient.name }}</span>
      </div>
      <div class="info-item">
        <span class="info-label">Admission Number:</span>
        <span class="info-value">{{ admission.admission_number }}</span>
      </div>
      <div class="info-item">
        <span class="info-label">Reference Number:</span>
        <span class="info-value">{{ admission.opd_patient.ref_no }}</span>
      </div>
      <div class="info-item">
        <span class="info-label">Phone:</span>
        <span class="info-value">{{ admission.opd_patient.phone|default:"N/A" }}</span>
      </div>
      <div class="info-item">
        <span class="info-label">Admission Date:</span>
        <span class="info-value">{{ admission.admission_date|date:"d M Y, h:i A" }}</span>
      </div>
      <div class="info-item">
        <span class="info-label">Discharge Date:</span>
        <span class="info-value">{{ admission.discharge_date|date:"d M Y, h:i A" }}</span>
      </div>
      <div class="info-item">
        <span class="info-label">Duration:</span>
        <span class="info-value">{{ duration_days }} day(s)</span>
      </div>
      <div class="info-item">
        <span class="info-label">Room:</span>
        <span class="info-value">
          {% if admission.room %}
            {{ admission.room.room_number }} - {{ admission.room.get_room_type_display }}
          {% else %}
            N/A
          {% endif %}
        </span>
      </div>
    </div>

    <h3 class="section-title">Bill Details</h3>

    <table>
      <thead>
        <tr>
          <th>Description</th>
          <th style="text-align: right;">Amount (Rs.)</th>
        </tr>
      </thead>
      <tbody>
        <tr>
          <td>Room Charges ({{ duration_days }} day{% if duration_days > 1 %}s{% endif %})</td>
          <td style="text-align: right;">{{ room_charges }}</td>
        </tr>
      </tbody>
    </table>

    {% if medicine_charges %}
    <h3 class="section-title">Medicine Charges</h3>
    <table>
      <thead>
        <tr>
          <th>Medicine Name</th>
          <th style="text-align: center;">Quantity</th>
          <th style="text-align: right;">Unit Price</th>
          <th style="text-align: right;">Total</th>
        </tr>
      </thead>
      <tbody>
        {% for charge in medicine_charges %}
        <tr>
          <td>{{ charge.medicine_name }}</td>
          <td style="text-align: center;">{{ charge.quantity }}</td>
          <td style="text-align: right;">{{ charge.unit_price }}</td>
          <td style="text-align: right;">{{ charge.total_price }}</td>
        </tr>
        {% endfor %}
        <tr class="total-row">
          <td colspan="3" style="text-align: right;"><strong>Total Medicine Charges:</strong></td>
          <td style="text-align: right;"><strong>{{ total_medicine }}</strong></td>
        </tr>
      </tbody>
    </table>
    {% endif %}

    {% if other_charges %}
    <h3 class="section-title">Other Charges</h3>
    <table>
      <thead>
        <tr>
          <th>Description</th>
          <th style="text-align: right;">Amount</th>
        </tr>
      </thead>
      <tbody>
        {% for charge in other_charges %}
        <tr>
          <td>{{ charge.description }}</td>
          <td style="text-align: right;">{{ charge.amount }}</td>
        </tr>
        {% endfor %}
        <tr class="total-row">
          <td style="text-align: right;"><strong>Total Other Charges:</strong></td>
          <td style="text-align: right;"><strong>{{ total_other }}</strong></td>
        </tr>
      </tbody>
    </table>
    {% endif %}

    <h3 class="section-title">Discount (Optional)</h3>
    <div style="background: #f8f9fa; padding: 20px; border-radius: 8px; margin-bottom: 20px;">
      <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
        <div>
          <label style="display: block; font-weight: 600; margin-bottom: 8px; color: #333;">Discount Amount (PKR)</label>
          <input type="number" id="discountAmount" placeholder="e.g., 50" min="0" step="0.01" oninput="updateDiscountFromAmount()" 
                 style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 5px; font-size: 1rem;">
        </div>
        <div>
          <label style="display: block; font-weight: 600; margin-bottom: 8px; color: #333;">Discount Percentage (%)</label>
          <input type="number" id="discountPercentage" placeholder="e.g., 10" min="0" max="100" step="0.01" oninput="updateDiscountFromPercentage()"
                 style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 5px; font-size: 1rem;">
        </div>
      </div>
    </div>

    <table>
      <tbody>
        <tr style="background: #f8f9fa;">
          <td><strong>Subtotal (Before Discount)</strong></td>
          <td style="text-align: right;"><strong>Rs. <span id="subtotal">{{ grand_total }}</span></strong></td>
        </tr>
        <tr style="background: #ffe6e6;">
          <td><strong>Discount</strong></td>
          <td style="text-align: right; color: #dc3545;"><strong>- Rs. <span id="discountDisplay">0.00</span> (<span id="discountPctDisplay">0.00</span>%)</strong></td>
        </tr>
        <tr class="grand-total-row">
          <td><strong>GRAND TOTAL</strong></td>
          <td style="text-align: right;"><strong>Rs. <span id="finalTotal">{{ grand_total }}</span></strong></td>
        </tr>
      </tbody>
    </table>

    {% if admission.discharge_summary %}
    <div style="background: #e8f5e9; padding: 20px; border-radius: 8px; border-left: 4px solid #28a745; margin: 30px 0;">
      <h4 style="color: #28a745; margin-bottom: 10px;"><i class="fas fa-check-circle"></i> Discharge Summary</h4>
      <p>{{ admission.discharge_summary }}</p>
    </div>
    {% endif %}

    <div class="action-buttons">
      <button onclick="window.print()" class="btn btn-print"><i class="fas fa-print"></i> Print Bill</button>
      <a href="{% url 'admitted_patients_pharmacy' %}" class="btn btn-back">Back to Pharmacy</a>
    </div>
  </div>
</div>

<!-- Thermal Receipt (Hidden, only shows when printing) -->
<div class="thermal-receipt" id="thermalReceipt">
  <div class="header">
    <div class="clinic-name">CLINIC MANAGEMENT</div>
    <div>Discharge Department</div>
    <div class="receipt-title">DISCHARGE BILL</div>
  </div>
  
  <div class="info-line">
    <span>Date:</span>
    <span id="receiptDate">{{ admission.discharge_date|date:"d/m/Y" }}</span>
  </div>
  <div class="info-line">
    <span>Time:</span>
    <span id="receiptTime">{{ admission.discharge_date|date:"h:i A" }}</span>
  </div>
  <div class="info-line">
    <span>Patient:</span>
    <span>{{ admission.opd_patient.name }}</span>
  </div>
  <div class="info-line">
    <span>Ref No:</span>
    <span>{{ admission.opd_patient.ref_no }}</span>
  </div>
  <div class="info-line">
    <span>Admission No:</span>
    <span>{{ admission.admission_number }}</span>
  </div>
  <div class="info-line">
    <span>Admitted:</span>
    <span>{{ admission.admission_date|date:"d/m/Y h:i A" }}</span>
  </div>
  <div class="info-line">
    <span>Discharged:</span>
    <span>{{ admission.discharge_date|date:"d/m/Y h:i A" }}</span>
  </div>
  <div class="info-line">
    <span>Duration:</span>
    <span>{{ duration_days }} day(s)</span>
  </div>
  
  <div class="section-title">BILL DETAILS</div>
  
  <div class="item-row">
    <div class="item-name">Room: {{ admission.room.name }}</div>
    <div class="item-details">
      <span>{{ duration_days }} day(s)</span>
      <span>Rs. {{ room_charges }}</span>
    </div>
  </div>
  
  {% if medicine_charges %}
  {% for charge in medicine_charges %}
  <div class="item-row">
    <div class="item-name">{{ charge.medicine_name }}</div>
    <div class="item-details">
      <span>{{ charge.quantity }} x Rs. {{ charge.unit_price }}</span>
      <span>Rs. {{ charge.total_price }}</span>
    </div>
  </div>
  {% endfor %}
  {% endif %}
  
  {% if other_charges %}
  {% for charge in other_charges %}
  <div class="item-row">
    <div class="item-name">{{ charge.description }}</div>
    <div class="item-details">
      <span></span>
      <span>Rs. {{ charge.amount }}</span>
    </div>
  </div>
  {% endfor %}
  {% endif %}
  
  <div class="totals">
    <div class="total-line">
      <span>Subtotal:</span>
      <span>Rs. <span id="receiptSubtotal">{{ grand_total }}</span></span>
    </div>
    <div class="total-line discount-line" id="receiptDiscountLine" style="display: none;">
      <span id="receiptDiscountLabel">Discount:</span>
      <span id="receiptDiscount">- Rs. 0.00</span>
    </div>
    <div class="total-line grand-total">
      <span>TOTAL:</span>
      <span>Rs. <span id="receiptGrandTotal">{{ grand_total }}</span></span>
    </div>
  </div>
  
  <div class="footer">
    <div class="thank-you">Thank You!</div>
    <div>Get well soon</div>
    <div>Clinic Management System</div>
  </div>
</div>

<script>
const originalTotal = {{ grand_total }};
let discountAmount = 0;
let discountPercentage = 0;

function updateDiscountFromAmount() {
  const amount = parseFloat(document.getElementById('discountAmount').value) || 0;
  
  // Limit discount to subtotal
  discountAmount = Math.min(amount, originalTotal);
  if (amount > originalTotal) {
    document.getElementById('discountAmount').value = originalTotal.toFixed(2);
  }
  
  // Calculate percentage
  discountPercentage = originalTotal > 0 ? (discountAmount / originalTotal) * 100 : 0;
  
  // Update percentage input
  document.getElementById('discountPercentage').value = discountPercentage.toFixed(2);
  
  // Update display
  updateDisplay();
}

function updateDiscountFromPercentage() {
  const percentage = parseFloat(document.getElementById('discountPercentage').value) || 0;
  
  // Limit percentage to 100
  discountPercentage = Math.min(percentage, 100);
  if (percentage > 100) {
    document.getElementById('discountPercentage').value = '100';
  }
  
  // Calculate amount
  discountAmount = (originalTotal * discountPercentage) / 100;
  
  // Update amount input
  document.getElementById('discountAmount').value = discountAmount.toFixed(2);
  
  // Update display
  updateDisplay();
}

function updateDisplay() {
  const finalTotal = originalTotal - discountAmount;
  
  // Update main bill display
  document.getElementById('discountDisplay').textContent = discountAmount.toFixed(2);
  document.getElementById('discountPctDisplay').textContent = discountPercentage.toFixed(2);
  document.getElementById('finalTotal').textContent = finalTotal.toFixed(2);
  
  // Update thermal receipt
  document.getElementById('receiptGrandTotal').textContent = finalTotal.toFixed(2);
  
  if (discountAmount > 0) {
    document.getElementById('receiptDiscountLine').style.display = 'flex';
    document.getElementById('receiptDiscountLabel').textContent = `Discount (${discountPercentage.toFixed(2)}%):`;
    document.getElementById('receiptDiscount').textContent = `- Rs. ${discountAmount.toFixed(2)}`;
  } else {
    document.getElementById('receiptDiscountLine').style.display = 'none';
  }
}

// Initialize display
updateDisplay();
</script>
{% endblock content %}
