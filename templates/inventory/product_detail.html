{% extends "inventory/base.html" %}
{% load static %}
{% load inventory_filters %}

{% block title %}{{ product.name }}{% endblock %}

{% block content %}
<div class="container py-4">
    <!-- Header -->
    <div class="row mb-4">
        <div class="col-md-8">
            <nav aria-label="breadcrumb">
                <ol class="breadcrumb">
                    <li class="breadcrumb-item"><a href="{% url 'inventory:product_list' %}">Inventory</a></li>
                    <li class="breadcrumb-item active">{{ product.name }}</li>
                </ol>
            </nav>
            <h1 class="display-5">{{ product.name }}</h1>
            {% if product.category %}
                <span class="badge bg-secondary fs-6">{{ product.category }}</span>
            {% endif %}
            {% if product.weight_or_quantity %}
                <span class="badge bg-info fs-6">{{ product.weight_or_quantity }}</span>
            {% endif %}
        </div>
        <div class="col-md-4 text-end">
            <a class="btn btn-outline-secondary me-2" href="{% url 'inventory:medicine_report' product.pk %}">
                <i class="fas fa-chart-bar me-2"></i>View Report
            </a>
            <a class="btn btn-outline-primary me-2" href="{% url 'inventory:product_update' product.pk %}">
                <i class="fas fa-edit me-2"></i>Edit Product
            </a>
            <a class="btn btn-success me-2" href="{% url 'inventory:add_batch' product.pk %}">
                <i class="fas fa-boxes me-2"></i>Add New Batch
            </a>
            <a class="btn btn-info" href="{% url 'inventory:product_sale' product.pk %}">
                <i class="fas fa-shopping-cart me-2"></i>Record Sale
            </a>
        </div>
    </div>

    <!-- Product Information Cards -->
    <div class="row g-4 mb-4">
        <!-- Stock Information -->
        <div class="col-lg-4">
            <div class="card border-0 shadow-sm h-100">
                <div class="card-header bg-primary text-white">
                    <h5 class="mb-0"><i class="fas fa-boxes me-2"></i>Current Stock</h5>
                </div>
                <div class="card-body">
                    <div class="mb-3">
                        <label class="text-muted small">Packs/Boxes</label>
                        <div class="h3 mb-0 {% if product.current_stock_boxes < 5 %}text-danger{% else %}text-success{% endif %}">
                            {{ product.current_stock_boxes|floatformat:0 }}
                        </div>
                    </div>
                    <div class="mb-3">
                        <label class="text-muted small">Strips/Sheets</label>
                        <div class="h4 mb-0">{{ product.current_stock_items|floatformat:0 }}</div>
                    </div>
                    <div>
                        <label class="text-muted small">Tablets/Units</label>
                        <div class="h4 mb-0">{{ product.current_stock_subitems|floatformat:0 }}</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Pricing Information -->
        <div class="col-lg-4">
            <div class="card border-0 shadow-sm h-100">
                <div class="card-header bg-success text-white">
                    <h5 class="mb-0"><i class="fas fa-dollar-sign me-2"></i>Purchase Pricing</h5>
                </div>
                <div class="card-body">
                    <div class="mb-3">
                        <label class="text-muted small">Per Pack</label>
                        <div class="h5 mb-0">Rs. {{ product.purchase_price|floatformat:2 }}</div>
                    </div>
                    <div class="mb-3">
                        <label class="text-muted small">Per Strip</label>
                        <div class="h6 mb-0">Rs. {{ product.purchase_price_per_item|floatformat:2 }}</div>
                    </div>
                    <div>
                        <label class="text-muted small">Per Tablet</label>
                        <div class="h6 mb-0">Rs. {{ product.purchase_price_per_subitem|floatformat:4 }}</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Sale Pricing -->
        <div class="col-lg-4">
            <div class="card border-0 shadow-sm h-100">
                <div class="card-header bg-info text-white">
                    <h5 class="mb-0"><i class="fas fa-tags me-2"></i>Sale Pricing</h5>
                </div>
                <div class="card-body">
                    <div class="mb-3">
                        <label class="text-muted small">Per Pack</label>
                        <div class="h5 mb-0 text-success">Rs. {{ product.sale_price|floatformat:2 }}</div>
                    </div>
                    <div class="mb-3">
                        <label class="text-muted small">Per Strip</label>
                        <div class="h6 mb-0 text-success">Rs. {{ product.sale_price_per_item|floatformat:2 }}</div>
                    </div>
                    <div>
                        <label class="text-muted small">Per Tablet</label>
                        <div class="h6 mb-0 text-success">Rs. {{ product.sale_price_per_subitem|floatformat:4 }}</div>
                    </div>
                    {% if product.purchase_margin_percent %}
                    <div class="mt-3 pt-3 border-top">
                        <small class="text-muted">Profit Margin: <strong>{{ product.purchase_margin_percent }}%</strong></small>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>

    <!-- Product Structure -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card border-0 shadow-sm">
                <div class="card-header bg-light">
                    <h5 class="mb-0"><i class="fas fa-layer-group me-2"></i>Product Structure</h5>
                </div>
                <div class="card-body">
                    <div class="row text-center">
                        <div class="col-md-4">
                            <div class="border rounded p-3">
                                <i class="fas fa-box fa-2x text-primary mb-2"></i>
                                <h6>1 Pack Contains</h6>
                                <h3 class="text-primary">{{ product.items_per_product }}</h3>
                                <small class="text-muted">Strips/Sheets</small>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="border rounded p-3">
                                <i class="fas fa-layer-group fa-2x text-success mb-2"></i>
                                <h6>1 Strip Contains</h6>
                                <h3 class="text-success">{{ product.subitems_per_item }}</h3>
                                <small class="text-muted">Tablets/Units</small>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="border rounded p-3 bg-light">
                                <i class="fas fa-calculator fa-2x text-info mb-2"></i>
                                <h6>Total per Pack</h6>
                                <h3 class="text-info">{{ product.items_per_product|mul:product.subitems_per_item }}</h3>
                                <small class="text-muted">Tablets/Units</small>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Additional Details -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card border-0 shadow-sm">
                <div class="card-header bg-light">
                    <h5 class="mb-0"><i class="fas fa-info-circle me-2"></i>Additional Details</h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-3">
                            <label class="text-muted small">Rack Number</label>
                            <div class="fw-bold">{{ product.rack_no|default:"Not Assigned" }}</div>
                        </div>
                        <div class="col-md-3">
                            <label class="text-muted small">Batch Number</label>
                            <div class="fw-bold">{{ product.batch_no|default:"—" }}</div>
                        </div>
                        <div class="col-md-3">
                            <label class="text-muted small">Expiry Date</label>
                            <div class="fw-bold {% if product.expiry_date %}text-danger{% endif %}">
                                {{ product.expiry_date|date:"M d, Y"|default:"Not Set" }}
                            </div>
                        </div>
                        <div class="col-md-3">
                            <label class="text-muted small">Receipt Date</label>
                            <div class="fw-bold">{{ product.inventory_receipt_date|date:"M d, Y" }}</div>
                        </div>
                    </div>
                    
                    <!-- Distributor Info -->
                    <div class="row mt-3 pt-3 border-top">
                        <div class="col-md-4">
                            <label class="text-muted small"><i class="fas fa-truck me-1"></i>Distributor/Supplier</label>
                            {% if product.distributor_ref %}
                            <div class="fw-bold">
                                <a href="{% url 'inventory:distributor_detail' product.distributor_ref.pk %}" class="text-decoration-none">
                                    {{ product.distributor_ref.name }}
                                </a>
                                {% if product.distributor_ref.balance_due > 0 %}
                                <span class="badge bg-danger ms-2">Due: Rs. {{ product.distributor_ref.balance_due }}</span>
                                {% endif %}
                            </div>
                            {% elif product.distributor %}
                            <div class="fw-bold">{{ product.distributor }}</div>
                            {% else %}
                            <div class="text-muted">Not Assigned</div>
                            {% endif %}
                        </div>
                        <div class="col-md-4">
                            <label class="text-muted small"><i class="fas fa-pills me-1"></i>Medicine Form</label>
                            <div class="fw-bold">{{ product.medicine_form|title|default:"—" }}</div>
                        </div>
                        <div class="col-md-4">
                            <label class="text-muted small"><i class="fas fa-bookmark me-1"></i>Category</label>
                            <div class="fw-bold">{{ product.category|default:"—" }}</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Batches Section -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card border-0 shadow-sm">
                <div class="card-header bg-success text-white d-flex justify-content-between align-items-center">
                    <h5 class="mb-0"><i class="fas fa-boxes me-2"></i>Product Batches (FEFO)</h5>
                    <a href="{% url 'inventory:add_batch' product.pk %}" class="btn btn-light btn-sm">
                        <i class="fas fa-plus me-1"></i>Add New Batch
                    </a>
                </div>
                <div class="card-body p-0">
                    <div class="table-responsive">
                        <table class="table table-hover mb-0">
                            <thead class="table-light">
                                <tr>
                                    <th>Batch No.</th>
                                    <th>Expiry Date</th>
                                    <th>Days Left</th>
                                    <th>Current Stock</th>
                                    <th>Purchase Price</th>
                                    <th>Sale Price</th>
                                    <th>Status</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for batch in all_batches %}
                                <tr class="{% if batch.is_expired %}table-danger{% elif batch.is_expiring_soon %}table-warning{% endif %}">
                                    <td><strong>{{ batch.batch_no|default:"N/A" }}</strong></td>
                                    <td>
                                        {% if batch.expiry_date %}
                                            {{ batch.expiry_date|date:"M d, Y" }}
                                        {% else %}
                                            <span class="text-muted">No Expiry</span>
                                        {% endif %}
                                    </td>
                                    <td>
                                        {% if batch.days_to_expiry is not None %}
                                            {% if batch.days_to_expiry < 0 %}
                                                <span class="badge bg-danger">Expired</span>
                                            {% elif batch.days_to_expiry <= 30 %}
                                                <span class="badge bg-danger">{{ batch.days_to_expiry }} days</span>
                                            {% elif batch.days_to_expiry <= 90 %}
                                                <span class="badge bg-warning text-dark">{{ batch.days_to_expiry }} days</span>
                                            {% else %}
                                                <span class="badge bg-success">{{ batch.days_to_expiry }} days</span>
                                            {% endif %}
                                        {% else %}
                                            <span class="text-muted">-</span>
                                        {% endif %}
                                    </td>
                                    <td>
                                        <strong>{{ batch.current_packs|floatformat:0 }}</strong> packs
                                        <small class="text-muted d-block">{{ batch.current_subitems|floatformat:0 }} tablets</small>
                                    </td>
                                    <td>Rs. {{ batch.net_purchase_price_per_pack|floatformat:2 }}</td>
                                    <td>
                                        {% if batch.sale_price_per_pack %}
                                            Rs. {{ batch.sale_price_per_pack|floatformat:2 }}
                                        {% else %}
                                            <span class="text-muted">-</span>
                                        {% endif %}
                                    </td>
                                    <td>
                                        {% if not batch.is_active %}
                                            <span class="badge bg-secondary">Sold Out</span>
                                        {% elif batch.is_expired %}
                                            <span class="badge bg-danger">Expired</span>
                                        {% elif batch.is_expiring_soon %}
                                            <span class="badge bg-warning text-dark">Expiring</span>
                                        {% else %}
                                            <span class="badge bg-success">Active</span>
                                        {% endif %}
                                    </td>
                                    <td>
                                        <a href="{% url 'inventory:batch_detail' batch.pk %}" class="btn btn-sm btn-outline-primary">
                                            <i class="fas fa-eye"></i>
                                        </a>
                                    </td>
                                </tr>
                                {% empty %}
                                <tr>
                                    <td colspan="8" class="text-center text-muted py-4">
                                        <i class="fas fa-box-open fa-3x mb-2 d-block"></i>
                                        No batches recorded yet
                                        <br>
                                        <a href="{% url 'inventory:add_batch' product.pk %}" class="btn btn-success mt-2">
                                            <i class="fas fa-plus me-1"></i>Add First Batch
                                        </a>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Transactions -->
    <div class="row">
        <div class="col-12">
            <div class="card border-0 shadow-sm">
                <div class="card-header bg-light">
                    <h5 class="mb-0"><i class="fas fa-history me-2"></i>Recent Transactions</h5>
                </div>
                <div class="card-body p-0">
                    <div class="table-responsive">
                        <table class="table table-hover mb-0">
                            <thead class="table-light">
                                <tr>
                                    <th>Date & Time</th>
                                    <th>Type</th>
                                    <th>Packs</th>
                                    <th>Strips</th>
                                    <th>Tablets</th>
                                    <th>Unit Price</th>
                                    <th>Notes</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for t in transactions %}
                                <tr>
                                    <td>{{ t.created_at|date:"M d, Y H:i" }}</td>
                                    <td>
                                        {% if t.transaction_type == 'PUR' %}
                                            <span class="badge bg-success">Purchase</span>
                                        {% elif t.transaction_type == 'SALE' %}
                                            <span class="badge bg-info">Sale</span>
                                        {% elif t.transaction_type == 'IN' %}
                                            <span class="badge bg-primary">Incoming</span>
                                        {% else %}
                                            <span class="badge bg-danger">Outgoing</span>
                                        {% endif %}
                                    </td>
                                    <td>{{ t.quantity_boxes|floatformat:0 }}</td>
                                    <td>{{ t.quantity_items|floatformat:0 }}</td>
                                    <td>{{ t.quantity_subitems|floatformat:0 }}</td>
                                    <td>Rs. {{ t.unit_purchase_price|floatformat:2 }}</td>
                                    <td><small>{{ t.notes|default:"—" }}</small></td>
                                </tr>
                                {% empty %}
                                <tr>
                                    <td colspan="7" class="text-center text-muted py-4">
                                        <i class="fas fa-inbox fa-3x mb-2 d-block"></i>
                                        No transactions yet
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}
