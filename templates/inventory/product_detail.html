{% extends "inventory/base.html" %}
{% load static %}
{% load inventory_filters %}

{% block title %}{{ product.name }}{% endblock %}

{% block content %}
<div class="container py-4">
    <!-- Header -->
    <div class="row mb-4">
        <div class="col-md-8">
            <nav aria-label="breadcrumb">
                <ol class="breadcrumb">
                    <li class="breadcrumb-item"><a href="{% url 'inventory:product_list' %}">Inventory</a></li>
                    <li class="breadcrumb-item active">{{ product.name }}</li>
                </ol>
            </nav>
            <h1 class="display-5">{{ product.name }}</h1>
            {% if product.category %}
                <span class="badge bg-secondary fs-6">{{ product.category }}</span>
            {% endif %}
            {% if product.weight_or_quantity %}
                <span class="badge bg-info fs-6">{{ product.weight_or_quantity }}</span>
            {% endif %}
        </div>
        <div class="col-md-4 text-end">
            <a class="btn btn-outline-secondary me-2" href="{% url 'inventory:medicine_report' product.pk %}">
                <i class="fas fa-chart-bar me-2"></i>View Report
            </a>
            <a class="btn btn-outline-primary me-2" href="{% url 'inventory:product_update' product.pk %}">
                <i class="fas fa-edit me-2"></i>Edit Product
            </a>
            <a class="btn btn-success me-2" href="{% url 'inventory:product_purchase' product.pk %}">
                <i class="fas fa-plus me-2"></i>Add Stock
            </a>
            <a class="btn btn-info" href="{% url 'inventory:product_sale' product.pk %}">
                <i class="fas fa-shopping-cart me-2"></i>Record Sale
            </a>
        </div>
    </div>

    <!-- Product Information Cards -->
    <div class="row g-4 mb-4">
        <!-- Stock Information -->
        <div class="col-lg-4">
            <div class="card border-0 shadow-sm h-100">
                <div class="card-header bg-primary text-white">
                    <h5 class="mb-0"><i class="fas fa-boxes me-2"></i>Current Stock</h5>
                </div>
                <div class="card-body">
                    <div class="mb-3">
                        <label class="text-muted small">Packs/Boxes</label>
                        <div class="h3 mb-0 {% if product.current_stock_boxes < 5 %}text-danger{% else %}text-success{% endif %}">
                            {{ product.current_stock_boxes|floatformat:0 }}
                        </div>
                    </div>
                    <div class="mb-3">
                        <label class="text-muted small">Strips/Sheets</label>
                        <div class="h4 mb-0">{{ product.current_stock_items|floatformat:0 }}</div>
                    </div>
                    <div>
                        <label class="text-muted small">Tablets/Units</label>
                        <div class="h4 mb-0">{{ product.current_stock_subitems|floatformat:0 }}</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Pricing Information -->
        <div class="col-lg-4">
            <div class="card border-0 shadow-sm h-100">
                <div class="card-header bg-success text-white">
                    <h5 class="mb-0"><i class="fas fa-dollar-sign me-2"></i>Purchase Pricing</h5>
                </div>
                <div class="card-body">
                    <div class="mb-3">
                        <label class="text-muted small">Per Pack</label>
                        <div class="h5 mb-0">Rs. {{ product.purchase_price|floatformat:2 }}</div>
                    </div>
                    <div class="mb-3">
                        <label class="text-muted small">Per Strip</label>
                        <div class="h6 mb-0">Rs. {{ product.purchase_price_per_item|floatformat:2 }}</div>
                    </div>
                    <div>
                        <label class="text-muted small">Per Tablet</label>
                        <div class="h6 mb-0">Rs. {{ product.purchase_price_per_subitem|floatformat:4 }}</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Sale Pricing -->
        <div class="col-lg-4">
            <div class="card border-0 shadow-sm h-100">
                <div class="card-header bg-info text-white">
                    <h5 class="mb-0"><i class="fas fa-tags me-2"></i>Sale Pricing</h5>
                </div>
                <div class="card-body">
                    <div class="mb-3">
                        <label class="text-muted small">Per Pack</label>
                        <div class="h5 mb-0 text-success">Rs. {{ product.sale_price|floatformat:2 }}</div>
                    </div>
                    <div class="mb-3">
                        <label class="text-muted small">Per Strip</label>
                        <div class="h6 mb-0 text-success">Rs. {{ product.sale_price_per_item|floatformat:2 }}</div>
                    </div>
                    <div>
                        <label class="text-muted small">Per Tablet</label>
                        <div class="h6 mb-0 text-success">Rs. {{ product.sale_price_per_subitem|floatformat:4 }}</div>
                    </div>
                    {% if product.purchase_margin_percent %}
                    <div class="mt-3 pt-3 border-top">
                        <small class="text-muted">Profit Margin: <strong>{{ product.purchase_margin_percent }}%</strong></small>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>

    <!-- Product Structure -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card border-0 shadow-sm">
                <div class="card-header bg-light">
                    <h5 class="mb-0"><i class="fas fa-layer-group me-2"></i>Product Structure</h5>
                </div>
                <div class="card-body">
                    <div class="row text-center">
                        <div class="col-md-4">
                            <div class="border rounded p-3">
                                <i class="fas fa-box fa-2x text-primary mb-2"></i>
                                <h6>1 Pack Contains</h6>
                                <h3 class="text-primary">{{ product.items_per_product }}</h3>
                                <small class="text-muted">Strips/Sheets</small>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="border rounded p-3">
                                <i class="fas fa-layer-group fa-2x text-success mb-2"></i>
                                <h6>1 Strip Contains</h6>
                                <h3 class="text-success">{{ product.subitems_per_item }}</h3>
                                <small class="text-muted">Tablets/Units</small>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="border rounded p-3 bg-light">
                                <i class="fas fa-calculator fa-2x text-info mb-2"></i>
                                <h6>Total per Pack</h6>
                                <h3 class="text-info">{{ product.items_per_product|mul:product.subitems_per_item }}</h3>
                                <small class="text-muted">Tablets/Units</small>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Additional Details -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card border-0 shadow-sm">
                <div class="card-header bg-light">
                    <h5 class="mb-0"><i class="fas fa-info-circle me-2"></i>Additional Details</h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-3">
                            <label class="text-muted small">Rack Number</label>
                            <div class="fw-bold">{{ product.rack_no|default:"Not Assigned" }}</div>
                        </div>
                        <div class="col-md-3">
                            <label class="text-muted small">Batch Number</label>
                            <div class="fw-bold">{{ product.batch_no|default:"—" }}</div>
                        </div>
                        <div class="col-md-3">
                            <label class="text-muted small">Expiry Date</label>
                            <div class="fw-bold {% if product.expiry_date %}text-danger{% endif %}">
                                {{ product.expiry_date|date:"M d, Y"|default:"Not Set" }}
                            </div>
                        </div>
                        <div class="col-md-3">
                            <label class="text-muted small">Receipt Date</label>
                            <div class="fw-bold">{{ product.inventory_receipt_date|date:"M d, Y" }}</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Transactions -->
    <div class="row">
        <div class="col-12">
            <div class="card border-0 shadow-sm">
                <div class="card-header bg-light">
                    <h5 class="mb-0"><i class="fas fa-history me-2"></i>Recent Transactions</h5>
                </div>
                <div class="card-body p-0">
                    <div class="table-responsive">
                        <table class="table table-hover mb-0">
                            <thead class="table-light">
                                <tr>
                                    <th>Date & Time</th>
                                    <th>Type</th>
                                    <th>Packs</th>
                                    <th>Strips</th>
                                    <th>Tablets</th>
                                    <th>Unit Price</th>
                                    <th>Notes</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for t in transactions %}
                                <tr>
                                    <td>{{ t.created_at|date:"M d, Y H:i" }}</td>
                                    <td>
                                        {% if t.transaction_type == 'PUR' %}
                                            <span class="badge bg-success">Purchase</span>
                                        {% elif t.transaction_type == 'SALE' %}
                                            <span class="badge bg-info">Sale</span>
                                        {% elif t.transaction_type == 'IN' %}
                                            <span class="badge bg-primary">Incoming</span>
                                        {% else %}
                                            <span class="badge bg-danger">Outgoing</span>
                                        {% endif %}
                                    </td>
                                    <td>{{ t.quantity_boxes|floatformat:0 }}</td>
                                    <td>{{ t.quantity_items|floatformat:0 }}</td>
                                    <td>{{ t.quantity_subitems|floatformat:0 }}</td>
                                    <td>Rs. {{ t.unit_purchase_price|floatformat:2 }}</td>
                                    <td><small>{{ t.notes|default:"—" }}</small></td>
                                </tr>
                                {% empty %}
                                <tr>
                                    <td colspan="7" class="text-center text-muted py-4">
                                        <i class="fas fa-inbox fa-3x mb-2 d-block"></i>
                                        No transactions yet
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}
