{% extends "inventory/base.html" %}
{% load static %}

{% block title %}{% if is_update %}Edit{% else %}Add New{% endif %} Medicine{% endblock %}

{% block content %}
<div class="container py-4">
    <div class="row justify-content-center">
        <div class="col-lg-8">
            <div class="card border-0 shadow-sm">
                <div class="card-header bg-primary text-white py-3">
                    <h4 class="mb-0">
                        <i class="fas fa-{% if is_update %}edit{% else %}plus-circle{% endif %} me-2"></i>
                        {% if is_update %}Edit Medicine: {{ product.name }}{% else %}Add New Medicine{% endif %}
                    </h4>
                </div>
                <div class="card-body p-4">
                    <form method="post" id="productForm">
                        {% csrf_token %}
                        
                        {% if form.errors %}
                            <div class="alert alert-danger alert-dismissible fade show" role="alert">
                                <strong>Error!</strong> Please correct the errors below.
                                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                            </div>
                        {% endif %}

                        <!-- Basic Information -->
                        <div class="section-header mb-3">
                            <h5 class="text-primary"><i class="fas fa-info-circle me-2"></i>Basic Information</h5>
                            <hr>
                        </div>

                        <div class="row g-3 mb-4">
                            <div class="col-md-8">
                                <label for="{{ form.name.id_for_label }}" class="form-label fw-bold">
                                    {{ form.name.label }} <span class="text-danger">*</span>
                                </label>
                                {{ form.name }}
                                {% if form.name.errors %}
                                    <div class="text-danger small mt-1">{{ form.name.errors }}</div>
                                {% endif %}
                            </div>
                            <div class="col-md-4">
                                <label for="{{ form.category.id_for_label }}" class="form-label fw-bold">
                                    {{ form.category.label }}
                                </label>
                                {{ form.category }}
                                {% if form.category.errors %}
                                    <div class="text-danger small mt-1">{{ form.category.errors }}</div>
                                {% endif %}
                            </div>
                        </div>

                        <div class="row g-3 mb-4">
                            <div class="col-md-6">
                                <label for="{{ form.weight_or_quantity.id_for_label }}" class="form-label fw-bold">
                                    {{ form.weight_or_quantity.label }}
                                </label>
                                {{ form.weight_or_quantity }}
                                <small class="text-muted d-block">e.g., 500mg, 100ml, 10mg</small>
                            </div>
                        </div>

                        <!-- Quantity Structure -->
                        <div class="section-header mb-3 mt-4">
                            <h5 class="text-primary"><i class="fas fa-layer-group me-2"></i>Quantity Structure</h5>
                            <hr>
                            <div class="alert alert-info">
                                <i class="fas fa-lightbulb me-2"></i>
                                <strong>Example:</strong> If you purchased 10 packs, each pack has 10 strips, and each strip has 15 tablets, enter:
                                <br><small>Packs: 10, Strips per Pack: 10, Tablets per Strip: 15</small>
                            </div>
                        </div>

                        <div class="row g-3 mb-4">
                            <div class="col-md-4">
                                <label for="{{ form.products_in_box.id_for_label }}" class="form-label fw-bold">
                                    {{ form.products_in_box.label }} <span class="text-danger">*</span>
                                </label>
                                {{ form.products_in_box }}
                                {% if form.products_in_box.errors %}
                                    <div class="text-danger small mt-1">{{ form.products_in_box.errors }}</div>
                                {% endif %}
                            </div>
                            <div class="col-md-4">
                                <label for="{{ form.items_per_product.id_for_label }}" class="form-label fw-bold">
                                    {{ form.items_per_product.label }} <span class="text-danger">*</span>
                                </label>
                                {{ form.items_per_product }}
                                {% if form.items_per_product.errors %}
                                    <div class="text-danger small mt-1">{{ form.items_per_product.errors }}</div>
                                {% endif %}
                            </div>
                            <div class="col-md-4">
                                <label for="{{ form.subitems_per_item.id_for_label }}" class="form-label fw-bold">
                                    {{ form.subitems_per_item.label }} <span class="text-danger">*</span>
                                </label>
                                {{ form.subitems_per_item }}
                                {% if form.subitems_per_item.errors %}
                                    <div class="text-danger small mt-1">{{ form.subitems_per_item.errors }}</div>
                                {% endif %}
                            </div>
                        </div>

                        <!-- Pricing Information -->
                        <div class="section-header mb-3 mt-4">
                            <h5 class="text-primary"><i class="fas fa-dollar-sign me-2"></i>Pricing Information</h5>
                            <hr>
                        </div>

                        <div class="row g-3 mb-4">
                            <div class="col-md-6">
                                <label for="{{ form.purchase_price.id_for_label }}" class="form-label fw-bold">
                                    {{ form.purchase_price.label }} <span class="text-danger">*</span>
                                </label>
                                {{ form.purchase_price }}
                                <small class="text-muted d-block">Total purchase price for all packs</small>
                                {% if form.purchase_price.errors %}
                                    <div class="text-danger small mt-1">{{ form.purchase_price.errors }}</div>
                                {% endif %}
                            </div>
                            <div class="col-md-6">
                                <label for="{{ form.purchase_margin_percent.id_for_label }}" class="form-label fw-bold">
                                    {{ form.purchase_margin_percent.label }} <span class="text-danger">*</span>
                                </label>
                                {{ form.purchase_margin_percent }}
                                <small class="text-muted d-block">Profit margin percentage</small>
                                {% if form.purchase_margin_percent.errors %}
                                    <div class="text-danger small mt-1">{{ form.purchase_margin_percent.errors }}</div>
                                {% endif %}
                            </div>
                        </div>

                        <!-- Price Calculator Display -->
                        <div class="alert alert-success" id="priceCalculator" style="display:none;">
                            <h6 class="fw-bold mb-2"><i class="fas fa-calculator me-2"></i>Calculated Prices:</h6>
                            <div class="row">
                                <div class="col-md-4">
                                    <small class="text-muted">Purchase Price per Pack:</small>
                                    <div class="fw-bold" id="purchasePricePerPack">-</div>
                                </div>
                                <div class="col-md-4">
                                    <small class="text-muted">Purchase Price per Strip:</small>
                                    <div class="fw-bold" id="purchasePricePerStrip">-</div>
                                </div>
                                <div class="col-md-4">
                                    <small class="text-muted">Purchase Price per Tablet:</small>
                                    <div class="fw-bold" id="purchasePricePerTablet">-</div>
                                </div>
                            </div>
                            <hr>
                            <div class="row mt-2">
                                <div class="col-md-4">
                                    <small class="text-muted">Sale Price per Pack:</small>
                                    <div class="fw-bold text-success" id="salePricePerPack">-</div>
                                </div>
                                <div class="col-md-4">
                                    <small class="text-muted">Sale Price per Strip:</small>
                                    <div class="fw-bold text-success" id="salePricePerStrip">-</div>
                                </div>
                                <div class="col-md-4">
                                    <small class="text-muted">Sale Price per Tablet:</small>
                                    <div class="fw-bold text-success" id="salePricePerTablet">-</div>
                                </div>
                            </div>
                        </div>

                        <!-- Additional Information -->
                        <div class="section-header mb-3 mt-4">
                            <h5 class="text-primary"><i class="fas fa-clipboard me-2"></i>Additional Information</h5>
                            <hr>
                        </div>

                        <div class="row g-3 mb-4">
                            <div class="col-md-4">
                                <label for="{{ form.rack_no.id_for_label }}" class="form-label fw-bold">
                                    {{ form.rack_no.label }}
                                </label>
                                {{ form.rack_no }}
                            </div>
                            <div class="col-md-4">
                                <label for="{{ form.expiry_date.id_for_label }}" class="form-label fw-bold">
                                    {{ form.expiry_date.label }}
                                </label>
                                {{ form.expiry_date }}
                            </div>
                            <div class="col-md-4">
                                <label for="{{ form.batch_no.id_for_label }}" class="form-label fw-bold">
                                    {{ form.batch_no.label }}
                                </label>
                                {{ form.batch_no }}
                            </div>
                        </div>

                        <!-- Form Actions -->
                        <div class="d-flex justify-content-between mt-4 pt-3 border-top">
                            <a href="{% if is_update %}{% url 'inventory:product_detail' product.pk %}{% else %}{% url 'inventory:product_list' %}{% endif %}" class="btn btn-outline-secondary">
                                <i class="fas fa-arrow-left me-2"></i>Cancel
                            </a>
                            <button type="submit" class="btn btn-primary btn-lg">
                                <i class="fas fa-save me-2"></i>{% if is_update %}Update{% else %}Save{% endif %} Medicine
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const packs = document.getElementById('id_products_in_box');
    const strips = document.getElementById('id_items_per_product');
    const tablets = document.getElementById('id_subitems_per_item');
    const purchasePrice = document.getElementById('id_purchase_price');
    const margin = document.getElementById('id_purchase_margin_percent');
    const calculator = document.getElementById('priceCalculator');

    function calculatePrices() {
        const packsVal = parseFloat(packs.value) || 1;
        const stripsVal = parseFloat(strips.value) || 1;
        const tabletsVal = parseFloat(tablets.value) || 1;
        const priceVal = parseFloat(purchasePrice.value) || 0;
        const marginVal = parseFloat(margin.value) || 0;

        if (priceVal > 0) {
            const pricePerPack = priceVal / packsVal;
            const pricePerStrip = pricePerPack / stripsVal;
            const pricePerTablet = pricePerStrip / tabletsVal;

            const saleMultiplier = 1 + (marginVal / 100);
            const salePerPack = pricePerPack * saleMultiplier;
            const salePerStrip = pricePerStrip * saleMultiplier;
            const salePerTablet = pricePerTablet * saleMultiplier;

            document.getElementById('purchasePricePerPack').textContent = 'Rs. ' + pricePerPack.toFixed(2);
            document.getElementById('purchasePricePerStrip').textContent = 'Rs. ' + pricePerStrip.toFixed(2);
            document.getElementById('purchasePricePerTablet').textContent = 'Rs. ' + pricePerTablet.toFixed(2);

            document.getElementById('salePricePerPack').textContent = 'Rs. ' + salePerPack.toFixed(2);
            document.getElementById('salePricePerStrip').textContent = 'Rs. ' + salePerStrip.toFixed(2);
            document.getElementById('salePricePerTablet').textContent = 'Rs. ' + salePerTablet.toFixed(2);

            calculator.style.display = 'block';
        } else {
            calculator.style.display = 'none';
        }
    }

    [packs, strips, tablets, purchasePrice, margin].forEach(element => {
        element.addEventListener('input', calculatePrices);
    });

    calculatePrices();
});
</script>
{% endblock %}
